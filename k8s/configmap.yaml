apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init
  namespace: ovh-checker
data:
  init.sql: |
    -- OVH Checker Database Schema

    -- Configuration table for Discord webhook and other settings
    CREATE TABLE IF NOT EXISTS config (
        key VARCHAR(255) PRIMARY KEY,
        value TEXT NOT NULL,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );

    -- Datacenter locations mapping
    CREATE TABLE IF NOT EXISTS datacenter_locations (
        datacenter_code VARCHAR(100) PRIMARY KEY,
        city VARCHAR(255) NOT NULL,
        country VARCHAR(255) NOT NULL,
        country_code VARCHAR(10),
        flag VARCHAR(10),
        region VARCHAR(50) NOT NULL,  -- US, EU, CA, APAC
        latitude DECIMAL(10, 7),
        longitude DECIMAL(10, 7)
    );

    -- Products/plans to monitor
    CREATE TABLE IF NOT EXISTS monitored_plans (
        id SERIAL PRIMARY KEY,
        plan_code VARCHAR(255) NOT NULL UNIQUE,
        display_name VARCHAR(255),
        url TEXT NOT NULL,
        purchase_url TEXT,
        enabled BOOLEAN DEFAULT TRUE,
        -- Lifecycle tracking
        catalog_status VARCHAR(50) DEFAULT 'active',  -- 'active', 'discontinued', 'new'
        first_seen_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        last_seen_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        discontinued_at TIMESTAMP WITH TIME ZONE,
        -- Visibility/orderable status from catalog tags
        is_orderable BOOLEAN DEFAULT TRUE,            -- has 'order-funnel:show' tag
        visibility_tags TEXT,                         -- comma-separated tags like 'order-funnel:show,website:show'
        -- Specs from catalog API
        vcpu INTEGER,
        ram_gb INTEGER,
        storage_gb INTEGER,
        storage_type VARCHAR(100),
        bandwidth_mbps INTEGER,
        description TEXT,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );

    -- Plan pricing (fetched from OVH catalog API)
    CREATE TABLE IF NOT EXISTS plan_pricing (
        id SERIAL PRIMARY KEY,
        plan_code VARCHAR(255) NOT NULL REFERENCES monitored_plans(plan_code) ON DELETE CASCADE,
        commitment_months INTEGER NOT NULL DEFAULT 0,  -- 0 = no commitment, 6, 12, 24, etc.
        price_microcents BIGINT NOT NULL,  -- Price in microcents (divide by 100000000 to get dollars)
        currency VARCHAR(10) NOT NULL DEFAULT 'USD',
        description VARCHAR(255),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        UNIQUE(plan_code, commitment_months)
    );

    CREATE INDEX IF NOT EXISTS idx_plan_pricing_plan_code ON plan_pricing(plan_code);

    -- Inventory status history
    CREATE TABLE IF NOT EXISTS inventory_status (
        id SERIAL PRIMARY KEY,
        plan_code VARCHAR(255) NOT NULL REFERENCES monitored_plans(plan_code),
        datacenter VARCHAR(100) NOT NULL,
        datacenter_code VARCHAR(100),
        is_available BOOLEAN NOT NULL,
        linux_status VARCHAR(50),
        raw_response JSONB,
        checked_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );

    -- Track when items go out of stock
    CREATE TABLE IF NOT EXISTS out_of_stock_tracking (
        id SERIAL PRIMARY KEY,
        plan_code VARCHAR(255) NOT NULL,
        datacenter VARCHAR(100) NOT NULL,
        out_of_stock_since TIMESTAMP WITH TIME ZONE NOT NULL,
        notified BOOLEAN DEFAULT FALSE,
        returned_to_stock_at TIMESTAMP WITH TIME ZONE,
        UNIQUE(plan_code, datacenter, out_of_stock_since)
    );

    -- Notification history
    CREATE TABLE IF NOT EXISTS notification_history (
        id SERIAL PRIMARY KEY,
        plan_code VARCHAR(255) NOT NULL,
        datacenter VARCHAR(100) NOT NULL,
        message TEXT NOT NULL,
        sent_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        success BOOLEAN NOT NULL,
        error_message TEXT
    );

    -- Create indexes for better query performance
    CREATE INDEX IF NOT EXISTS idx_inventory_status_plan_code ON inventory_status(plan_code);
    CREATE INDEX IF NOT EXISTS idx_inventory_status_checked_at ON inventory_status(checked_at);
    CREATE INDEX IF NOT EXISTS idx_out_of_stock_tracking_plan_dc ON out_of_stock_tracking(plan_code, datacenter);

    -- Insert default config values
    INSERT INTO config (key, value) VALUES ('discord_webhook_url', 'https://discord.com/api/webhooks/1462666317479018690/r7QwMv3gFFi67KeBXH9H8GUapSNCXWTt9FSiNx5Lg2k8bZnwAfuRBsd-9kq0nLR1Yhtt') ON CONFLICT (key) DO NOTHING;
    INSERT INTO config (key, value) VALUES ('notification_threshold_minutes', '60') ON CONFLICT (key) DO NOTHING;
    INSERT INTO config (key, value) VALUES ('check_interval_seconds', '120') ON CONFLICT (key) DO NOTHING;
    INSERT INTO config (key, value) VALUES ('pricing_last_updated', '') ON CONFLICT (key) DO NOTHING;
    INSERT INTO config (key, value) VALUES ('catalog_last_synced', '') ON CONFLICT (key) DO NOTHING;
    INSERT INTO config (key, value) VALUES ('ovh_subsidiary', 'US') ON CONFLICT (key) DO NOTHING;

    -- NOTE: All data is now auto-discovered from OVH APIs:
    --   - monitored_plans: Synced daily from Order Catalog API with specs and pricing
    --   - datacenter_locations: Synced from catalog (city/country) with code mappings from availability API
    -- No need to hardcode anything - the checker service handles all discovery automatically
