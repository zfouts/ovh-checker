apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init
  namespace: ovh-checker
data:
  init.sql: |
    -- OVH Checker Database Schema

    -- Configuration table for Discord webhook and other settings
    CREATE TABLE IF NOT EXISTS config (
        key VARCHAR(255) PRIMARY KEY,
        value TEXT NOT NULL,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );

    -- Datacenter locations mapping
    CREATE TABLE IF NOT EXISTS datacenter_locations (
        datacenter_code VARCHAR(100) PRIMARY KEY,
        city VARCHAR(255) NOT NULL,
        country VARCHAR(255) NOT NULL,
        country_code VARCHAR(10),
        flag VARCHAR(10),
        region VARCHAR(50) NOT NULL,  -- US, EU, CA, APAC
        latitude DECIMAL(10, 7),
        longitude DECIMAL(10, 7)
    );

    -- Products/plans to monitor
    CREATE TABLE IF NOT EXISTS monitored_plans (
        id SERIAL PRIMARY KEY,
        plan_code VARCHAR(255) NOT NULL UNIQUE,
        display_name VARCHAR(255),
        url TEXT NOT NULL,
        purchase_url TEXT,
        enabled BOOLEAN DEFAULT TRUE,
        -- Lifecycle tracking
        catalog_status VARCHAR(50) DEFAULT 'active',  -- 'active', 'discontinued', 'new'
        first_seen_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        last_seen_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        discontinued_at TIMESTAMP WITH TIME ZONE,
        -- Visibility/orderable status from catalog tags
        is_orderable BOOLEAN DEFAULT TRUE,            -- has 'order-funnel:show' tag
        visibility_tags TEXT,                         -- comma-separated tags like 'order-funnel:show,website:show'
        -- Specs from catalog API
        vcpu INTEGER,
        ram_gb INTEGER,
        storage_gb INTEGER,
        storage_type VARCHAR(100),
        bandwidth_mbps INTEGER,
        description TEXT,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );

    -- Plan pricing (fetched from OVH catalog API)
    CREATE TABLE IF NOT EXISTS plan_pricing (
        id SERIAL PRIMARY KEY,
        plan_code VARCHAR(255) NOT NULL REFERENCES monitored_plans(plan_code) ON DELETE CASCADE,
        commitment_months INTEGER NOT NULL DEFAULT 0,  -- 0 = no commitment, 6, 12, 24, etc.
        price_microcents BIGINT NOT NULL,  -- Price in microcents (divide by 100000000 to get dollars)
        currency VARCHAR(10) NOT NULL DEFAULT 'USD',
        description VARCHAR(255),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        UNIQUE(plan_code, commitment_months)
    );

    CREATE INDEX IF NOT EXISTS idx_plan_pricing_plan_code ON plan_pricing(plan_code);

    -- Inventory status history
    CREATE TABLE IF NOT EXISTS inventory_status (
        id SERIAL PRIMARY KEY,
        plan_code VARCHAR(255) NOT NULL REFERENCES monitored_plans(plan_code),
        datacenter VARCHAR(100) NOT NULL,
        datacenter_code VARCHAR(100),
        is_available BOOLEAN NOT NULL,
        linux_status VARCHAR(50),
        raw_response JSONB,
        checked_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );

    -- Track when items go out of stock
    CREATE TABLE IF NOT EXISTS out_of_stock_tracking (
        id SERIAL PRIMARY KEY,
        plan_code VARCHAR(255) NOT NULL,
        datacenter VARCHAR(100) NOT NULL,
        out_of_stock_since TIMESTAMP WITH TIME ZONE NOT NULL,
        notified BOOLEAN DEFAULT FALSE,
        returned_to_stock_at TIMESTAMP WITH TIME ZONE,
        UNIQUE(plan_code, datacenter, out_of_stock_since)
    );

    -- Notification history
    CREATE TABLE IF NOT EXISTS notification_history (
        id SERIAL PRIMARY KEY,
        plan_code VARCHAR(255) NOT NULL,
        datacenter VARCHAR(100) NOT NULL,
        message TEXT NOT NULL,
        sent_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        success BOOLEAN NOT NULL,
        error_message TEXT
    );

    -- Create indexes for better query performance
    CREATE INDEX IF NOT EXISTS idx_inventory_status_plan_code ON inventory_status(plan_code);
    CREATE INDEX IF NOT EXISTS idx_inventory_status_checked_at ON inventory_status(checked_at);
    CREATE INDEX IF NOT EXISTS idx_out_of_stock_tracking_plan_dc ON out_of_stock_tracking(plan_code, datacenter);

    -- Insert default config values (no webhook URL by default - must be configured)
    INSERT INTO config (key, value) VALUES ('discord_webhook_url', '') ON CONFLICT (key) DO NOTHING;
    INSERT INTO config (key, value) VALUES ('notification_threshold_minutes', '60') ON CONFLICT (key) DO NOTHING;
    INSERT INTO config (key, value) VALUES ('check_interval_seconds', '120') ON CONFLICT (key) DO NOTHING;
    INSERT INTO config (key, value) VALUES ('pricing_last_updated', '') ON CONFLICT (key) DO NOTHING;
    INSERT INTO config (key, value) VALUES ('catalog_last_synced', '') ON CONFLICT (key) DO NOTHING;
    INSERT INTO config (key, value) VALUES ('ovh_subsidiary', 'US') ON CONFLICT (key) DO NOTHING;

    -- ============================================================================
    -- USERS TABLE
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        email VARCHAR(255) NOT NULL UNIQUE,
        username VARCHAR(100) NOT NULL UNIQUE,
        password_hash VARCHAR(255) NOT NULL,
        is_active BOOLEAN DEFAULT TRUE,
        is_admin BOOLEAN DEFAULT FALSE,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        last_login_at TIMESTAMP WITH TIME ZONE
    );

    CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
    CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);

    -- ============================================================================
    -- USER DISCORD WEBHOOKS (each user can have their own webhook)
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS user_webhooks (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        webhook_url TEXT NOT NULL,
        webhook_name VARCHAR(255) DEFAULT 'My Discord',
        is_active BOOLEAN DEFAULT TRUE,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_user_webhooks_user_id ON user_webhooks(user_id);

    -- ============================================================================
    -- USER PLAN SUBSCRIPTIONS (which plans each user wants notifications for)
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS user_plan_subscriptions (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        plan_code VARCHAR(255) NOT NULL REFERENCES monitored_plans(plan_code) ON DELETE CASCADE,
        notify_on_available BOOLEAN DEFAULT TRUE,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        UNIQUE(user_id, plan_code)
    );

    CREATE INDEX IF NOT EXISTS idx_user_plan_subs_user_id ON user_plan_subscriptions(user_id);
    CREATE INDEX IF NOT EXISTS idx_user_plan_subs_plan_code ON user_plan_subscriptions(plan_code);

    -- ============================================================================
    -- USER NOTIFICATION HISTORY (track notifications per user)
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS user_notification_history (
        id SERIAL PRIMARY KEY,
        user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
        webhook_id INTEGER REFERENCES user_webhooks(id) ON DELETE SET NULL,
        plan_code VARCHAR(255) NOT NULL,
        datacenter VARCHAR(100) NOT NULL,
        message TEXT NOT NULL,
        sent_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        success BOOLEAN NOT NULL,
        error_message TEXT,
        is_default_webhook BOOLEAN DEFAULT FALSE
    );

    CREATE INDEX IF NOT EXISTS idx_user_notif_history_user_id ON user_notification_history(user_id);
    CREATE INDEX IF NOT EXISTS idx_user_notif_history_sent_at ON user_notification_history(sent_at);

    -- ============================================================================
    -- SESSION TOKENS (for JWT refresh tokens / revocation)
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS refresh_tokens (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        token_hash VARCHAR(255) NOT NULL UNIQUE,
        expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        revoked_at TIMESTAMP WITH TIME ZONE
    );

    CREATE INDEX IF NOT EXISTS idx_refresh_tokens_user_id ON refresh_tokens(user_id);
    CREATE INDEX IF NOT EXISTS idx_refresh_tokens_expires ON refresh_tokens(expires_at);

    -- ============================================================================
    -- API KEYS (optional: for programmatic access)
    -- ============================================================================
    CREATE TABLE IF NOT EXISTS api_keys (
        id SERIAL PRIMARY KEY,
        user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        key_hash VARCHAR(255) NOT NULL UNIQUE,
        name VARCHAR(255) NOT NULL,
        last_used_at TIMESTAMP WITH TIME ZONE,
        expires_at TIMESTAMP WITH TIME ZONE,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        revoked_at TIMESTAMP WITH TIME ZONE
    );

    CREATE INDEX IF NOT EXISTS idx_api_keys_user_id ON api_keys(user_id);

    -- ============================================================================
    -- ADMIN USER BOOTSTRAP
    -- ============================================================================
    -- NOTE: Admin user is created automatically by the API on first startup
    -- with a secure randomly generated password logged to stdout.
    -- Check: kubectl logs deployment/api -n ovh-checker | grep -A5 "INITIAL ADMIN"

    -- ============================================================================
    -- SLACK WEBHOOK SUPPORT (Migration 002)
    -- ============================================================================
    -- Add webhook_type column for Discord/Slack distinction
    DO $$
    BEGIN
        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns 
            WHERE table_name = 'user_webhooks' AND column_name = 'webhook_type'
        ) THEN
            ALTER TABLE user_webhooks ADD COLUMN webhook_type VARCHAR(20) DEFAULT 'discord';
        END IF;
        
        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns 
            WHERE table_name = 'user_webhooks' AND column_name = 'slack_channel'
        ) THEN
            ALTER TABLE user_webhooks ADD COLUMN slack_channel VARCHAR(100) DEFAULT NULL;
        END IF;
    END $$;
    
    CREATE INDEX IF NOT EXISTS idx_user_webhooks_type ON user_webhooks(webhook_type);

    -- NOTE: All data is now auto-discovered from OVH APIs:
    --   - monitored_plans: Synced daily from Order Catalog API with specs and pricing
    --   - datacenter_locations: Synced from catalog (city/country) with code mappings from availability API
    -- No need to hardcode anything - the checker service handles all discovery automatically
