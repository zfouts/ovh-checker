<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OVH Inventory Checker</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-hover: #30363d;
            --border: #30363d;
            --border-light: #21262d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent: #58a6ff;
            --accent-hover: #79b8ff;
            --success: #3fb950;
            --success-bg: rgba(63, 185, 80, 0.15);
            --danger: #f85149;
            --danger-bg: rgba(248, 81, 73, 0.15);
            --warning: #d29922;
            --warning-bg: rgba(210, 153, 34, 0.15);
            --purple: #a371f7;
            --shadow: 0 8px 24px rgba(0,0,0,0.4);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        a { color: var(--accent); text-decoration: none; transition: color 0.2s; }
        a:hover { color: var(--accent-hover); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        
        .container { max-width: 1600px; margin: 0 auto; padding: 0 24px; }
        
        /* Header */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .logo h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .logo h1 a { color: inherit; }
        
        .header-stats {
            display: flex;
            gap: 24px;
            font-size: 0.875rem;
        }
        
        .header-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }
        
        .header-stat .value {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .live-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--success);
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.9); }
        }
        
        /* Subsidiary Tabs */
        .subsidiary-tabs {
            display: flex;
            gap: 4px;
            padding: 16px 0;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }
        
        .subsidiary-tab {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s;
            white-space: nowrap;
            cursor: pointer;
            border: 1px solid transparent;
            background: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .subsidiary-tab:hover { 
            color: var(--text-primary); 
            background: var(--bg-tertiary);
        }
        
        .subsidiary-tab.active { 
            color: var(--text-primary); 
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }
        
        .subsidiary-tab .flag { font-size: 1.1rem; }
        .subsidiary-tab .count {
            font-size: 0.75rem;
            padding: 2px 6px;
            background: var(--bg-hover);
            border-radius: 10px;
            color: var(--text-muted);
        }
        
        .subsidiary-tab.active .count {
            background: var(--accent);
            color: var(--text-primary);
        }
        
        /* Navigation */
        .nav {
            display: flex;
            gap: 4px;
            padding: 0 0 16px;
            overflow-x: auto;
        }
        
        .nav-item {
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s;
            white-space: nowrap;
            cursor: pointer;
            border: none;
            background: none;
        }
        
        .nav-item:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .nav-item.active { color: var(--text-primary); background: var(--bg-tertiary); }
        
        /* Main content */
        main { padding: 24px 0 80px; }
        
        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }
        
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .card-body { padding: 20px; }
        
        /* Filters */
        .filters-section { margin-bottom: 24px; }
        
        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 160px;
            flex: 1;
            max-width: 220px;
        }
        
        .filter-group label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filter-input, .filter-select {
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.2s;
            width: 100%;
        }
        
        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
        }
        
        .filter-select { cursor: pointer; }
        
        .filter-actions {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        
        /* Active filters */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .filter-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--accent);
            background: rgba(88, 166, 255, 0.15);
            border: 1px solid var(--accent);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--accent);
        }
        
        .filter-tag button {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .filter-tag button:hover { opacity: 1; }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
        }
        .btn-primary:hover { background: var(--accent-hover); }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover { background: var(--bg-hover); border-color: var(--text-muted); }
        
        .btn-success { background: var(--success); color: var(--bg-primary); }
        .btn-success:hover { filter: brightness(1.1); }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { filter: brightness(1.1); }
        
        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }
        .btn-ghost:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        
        .btn-sm { padding: 6px 12px; font-size: 0.8125rem; }
        .btn-icon { padding: 8px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .stat-card.success { border-left: 3px solid var(--success); }
        .stat-card.danger { border-left: 3px solid var(--danger); }
        .stat-card.info { border-left: 3px solid var(--accent); }
        .stat-card.purple { border-left: 3px solid var(--purple); }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }
        
        .stat-card.success .stat-value { color: var(--success); }
        .stat-card.danger .stat-value { color: var(--danger); }
        .stat-card.info .stat-value { color: var(--accent); }
        .stat-card.purple .stat-value { color: var(--purple); }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* Region notice banner */
        .region-notice {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .region-notice .region-flag {
            font-size: 1.5rem;
        }
        
        .region-notice .region-text strong {
            color: var(--text-primary);
        }
        
        .region-notice .region-hint {
            color: var(--text-muted);
            font-size: 0.8125rem;
        }
        
        /* Plan groups */
        .plans-grid { display: flex; flex-direction: column; gap: 20px; }
        
        /* Section headers for orderable vs internal */
        .plans-section { margin-bottom: 32px; }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .section-badge {
            padding: 4px 12px;
            background: rgba(88, 166, 255, 0.15);
            color: var(--accent);
            border-radius: 12px;
            font-size: 0.8125rem;
            font-weight: 500;
        }
        
        .section-badge.muted {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }
        
        .section-hint {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }
        
        .internal-section .section-header {
            border-bottom: 1px dashed var(--border);
        }
        
        .plan-group.internal {
            opacity: 0.85;
            border-style: dashed;
        }
        
        .plan-card.internal {
            border-style: dashed;
        }
        
        .badge-muted {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-size: 0.6875rem;
        }
        
        .plan-price.muted {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }
        
        .plan-group {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .group-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        
        .group-header:hover { background: var(--bg-tertiary); }
        
        .plan-group.collapsed .group-header { border-bottom: none; }
        .plan-group.collapsed .plan-expand { transform: rotate(-90deg); }
        
        .group-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .group-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .group-badge {
            padding: 4px 10px;
            background: var(--accent);
            background: rgba(88, 166, 255, 0.15);
            color: var(--accent);
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .group-stats {
            display: flex;
            gap: 16px;
        }
        
        .group-variants {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* Plan cards */
        .plan-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            transition: border-color 0.2s;
        }
        
        .plan-card:hover { border-color: var(--text-muted); }
        
        .plan-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .plan-header:hover { background: var(--bg-tertiary); }
        
        .plan-info { flex: 1; min-width: 0; }
        
        .plan-title-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 4px;
        }
        
        .plan-expand {
            color: var(--text-muted);
            font-size: 0.75rem;
            transition: transform 0.2s;
        }
        
        .plan-card.collapsed .plan-expand { transform: rotate(-90deg); }
        
        .plan-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .plan-code {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .plan-specs {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 12px;
        }
        
        .spec-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }
        
        .spec-icon { font-size: 1rem; }
        
        .plan-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        
        .plan-price {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .plan-price:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
        }
        
        .plan-order {
            padding: 8px 16px;
            background: var(--success);
            border-radius: var(--radius-sm);
            color: var(--bg-primary);
            font-weight: 600;
            font-size: 0.8125rem;
            text-decoration: none;
            transition: filter 0.2s;
        }
        
        .plan-order:hover { filter: brightness(1.1); color: var(--bg-primary); }
        
        .plan-summary {
            display: flex;
            gap: 16px;
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
            font-size: 0.8125rem;
        }
        
        .summary-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .summary-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .summary-dot.green { background: var(--success); }
        .summary-dot.red { background: var(--danger); }
        
        .plan-datacenters {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 12px;
            padding: 20px;
            border-top: 1px solid var(--border);
        }
        
        .plan-card.collapsed .plan-datacenters { display: none; }
        
        .dc-card {
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dc-card:hover { border-color: var(--text-muted); transform: translateY(-2px); }
        
        .dc-card.available { border-left: 3px solid var(--success); }
        .dc-card.unavailable { border-left: 3px solid var(--danger); }
        .dc-card.highlighted { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2); }
        
        .dc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }
        
        .dc-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
        }
        
        .dc-location {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .dc-code {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'SF Mono', Monaco, monospace;
            margin-bottom: 8px;
        }
        
        .dc-link {
            color: var(--text-muted);
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .dc-card:hover .dc-link { opacity: 1; }
        
        .dc-status {
            font-size: 0.8125rem;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .dc-status.available { color: var(--success); }
        .dc-status.unavailable { color: var(--danger); }
        
        .dc-details {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .dc-outage {
            font-size: 0.75rem;
            color: var(--warning);
            margin-top: 8px;
            padding: 6px 10px;
            background: var(--warning-bg);
            border-radius: var(--radius-sm);
        }
        
        /* Tables */
        .table-wrapper {
            overflow-x: auto;
            max-height: 500px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--bg-tertiary);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        tr:hover td { background: var(--bg-tertiary); }
        
        td { font-size: 0.875rem; }
        
        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-success { background: var(--success-bg); color: var(--success); }
        .badge-danger { background: var(--danger-bg); color: var(--danger); }
        .badge-info { background: rgba(88, 166, 255, 0.15); color: var(--accent); }
        .badge-muted { background: var(--bg-tertiary); color: var(--text-muted); }
        
        /* Forms */
        .form-group { margin-bottom: 20px; }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.9375rem;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
        }
        
        .form-hint {
            margin-top: 6px;
            font-size: 0.8125rem;
            color: var(--text-muted);
        }
        
        /* Alerts */
        .alert {
            padding: 16px 20px;
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-success { background: var(--success-bg); color: var(--success); border: 1px solid var(--success); }
        .alert-danger { background: var(--danger-bg); color: var(--danger); border: 1px solid var(--danger); }
        .alert-info { background: rgba(88, 166, 255, 0.1); color: var(--accent); border: 1px solid var(--accent); }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 24px;
        }
        
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            max-width: 480px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
        }
        
        .modal-close:hover { color: var(--text-primary); }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(80vh - 140px);
        }
        
        .pricing-tier {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        
        .pricing-tier.best {
            border-color: var(--success);
            background: var(--success-bg);
        }
        
        .pricing-label { font-weight: 500; }
        .pricing-label small { display: block; color: var(--success); font-size: 0.75rem; margin-top: 2px; }
        
        .pricing-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .pricing-note {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            font-size: 0.8125rem;
            color: var(--text-muted);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.875rem;
            box-shadow: var(--shadow);
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--text-muted);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .spinner-sm {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 24px;
            color: var(--text-muted);
        }
        
        .empty-state h3 {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        /* Refresh indicator */
        .refresh-indicator {
            position: fixed;
            top: 80px;
            right: 24px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 50;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s;
        }
        
        .refresh-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .refresh-indicator .mini-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 16px; }
            
            .header-stats { display: none; }
            
            .filter-group { max-width: none; }
            
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            
            .plan-header { flex-direction: column; }
            .plan-actions { width: 100%; justify-content: flex-start; }
            
            .plan-datacenters { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <div class="logo-icon">üì°</div>
                        <h1><a href="#/">OVH Inventory</a></h1>
                    </div>
                    
                    <div class="header-stats">
                        <div class="header-stat">
                            <span>Monitoring</span>
                            <span class="value">{{ totalPlans }} plans</span>
                        </div>
                        <div class="header-stat">
                            <span>Across</span>
                            <span class="value">{{ totalDatacenters }} datacenters</span>
                        </div>
                        <div class="live-indicator">
                            <span class="live-dot"></span>
                            <span>Live</span>
                        </div>
                    </div>
                </div>
                
                <nav class="nav">
                    <a class="nav-item" :class="{ active: activeTab === 'status' }" href="#/status">Status</a>
                    <a class="nav-item" :class="{ active: activeTab === 'datacenter' }" href="#/datacenter">Datacenter</a>
                    <a class="nav-item" :class="{ active: activeTab === 'history' }" href="#/history" v-if="isAuthenticated">History</a>
                    <a class="nav-item" :class="{ active: activeTab === 'notifications' }" href="#/notifications" v-if="isAuthenticated">Notifications</a>
                    <a class="nav-item" :class="{ active: activeTab === 'my-alerts' }" href="#/my-alerts" v-if="isAuthenticated">My Alerts</a>
                    <a class="nav-item" :class="{ active: activeTab === 'admin' }" href="#/admin" v-if="isAdmin">Admin</a>
                    <a class="nav-item" :class="{ active: activeTab === 'settings' }" href="#/settings" v-if="isAdmin">Settings</a>
                    
                    <!-- Auth buttons -->
                    <div style="margin-left: auto; display: flex; gap: 8px; align-items: center;">
                        <template v-if="isAuthenticated">
                            <span style="color: var(--text-secondary); font-size: 0.875rem;">{{ currentUser?.email }}</span>
                            <button class="btn btn-ghost btn-sm" @click="logout">Logout</button>
                        </template>
                        <template v-else>
                            <button class="btn btn-ghost btn-sm" @click="showLoginModal = true">Login</button>
                            <button class="btn btn-primary btn-sm" @click="showRegisterModal = true">Sign Up</button>
                        </template>
                    </div>
                </nav>
            </div>
        </header>

        <main>
            <div class="container">
                <!-- Status Tab -->
                <div v-if="activeTab === 'status'">
                    <!-- Subsidiary Tabs -->
                    <div class="subsidiary-tabs" v-if="subsidiariesWithData.length > 1">
                        <button 
                            v-for="sub in subsidiariesWithData" 
                            :key="sub"
                            class="subsidiary-tab" 
                            :class="{ active: activeSubsidiary === sub }"
                            @click="setActiveSubsidiary(sub)"
                        >
                            <span class="flag">{{ getSubsidiaryFlag(sub) }}</span>
                            <span>{{ getSubsidiaryName(sub) }}</span>
                            <span class="count">{{ getSubsidiaryCount(sub) }}</span>
                        </button>
                        <button 
                            class="subsidiary-tab" 
                            :class="{ active: activeSubsidiary === 'ALL' }"
                            @click="setActiveSubsidiary('ALL')"
                        >
                            <span class="flag">üåç</span>
                            <span>All Regions</span>
                            <span class="count">{{ status.length }}</span>
                        </button>
                    </div>

                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card success">
                            <div class="stat-value">{{ stats.available }}</div>
                            <div class="stat-label">Available</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-value">{{ stats.outOfStock }}</div>
                            <div class="stat-label">Out of Stock</div>
                        </div>
                        <div class="stat-card info">
                            <div class="stat-value">{{ stats.plans }}</div>
                            <div class="stat-label">Active Plans</div>
                        </div>
                        <div class="stat-card purple">
                            <div class="stat-value">{{ stats.datacenters }}</div>
                            <div class="stat-label">Datacenters</div>
                        </div>
                    </div>

                    <!-- Region Notice -->
                    <div class="region-notice" v-if="activeSubsidiary !== 'ALL'">
                        <span class="region-flag">{{ getSubsidiaryFlag(activeSubsidiary) }}</span>
                        <div class="region-text">
                            <div><strong>{{ getSubsidiaryName(activeSubsidiary) }}</strong> ‚Äî Availability data for the {{ activeSubsidiary }} subsidiary</div>
                            <div class="region-hint">‚ö†Ô∏è Some datacenters may have regional restrictions. Availability varies by account location and eligibility.</div>
                        </div>
                    </div>
                    <div class="region-notice" v-else>
                        <span class="region-flag">üåç</span>
                        <div class="region-text">
                            <div><strong>All Regions</strong> ‚Äî Monitoring {{ subsidiariesWithData.length }} OVH subsidiaries</div>
                            <div class="region-hint">üìä Compare pricing and availability across {{ subsidiariesWithData.map(s => getSubsidiaryName(s)).join(', ') }}</div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="filters-section card">
                        <div class="card-body">
                            <div class="filters-row">
                                <div class="filter-group">
                                    <label>Search</label>
                                    <input type="text" class="filter-input" v-model="filters.search" 
                                           placeholder="Plan or datacenter..." @input="updateUrl">
                                </div>
                                <div class="filter-group">
                                    <label>Plan</label>
                                    <select class="filter-select" v-model="filters.plan" @change="updateUrl">
                                        <option value="">All Plans</option>
                                        <option v-for="p in availablePlans" :key="p" :value="p">{{ p }}</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Datacenter</label>
                                    <select class="filter-select" v-model="filters.datacenter" @change="updateUrl">
                                        <option value="">All Datacenters</option>
                                        <option v-for="dc in availableDatacenters" :key="dc" :value="dc">{{ dc }}</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Status</label>
                                    <select class="filter-select" v-model="filters.status" @change="updateUrl">
                                        <option value="">All</option>
                                        <option value="available">Available</option>
                                        <option value="unavailable">Out of Stock</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Region</label>
                                    <select class="filter-select" v-model="filters.region" @change="updateUrl">
                                        <option value="">All Regions</option>
                                        <option value="US">US</option>
                                        <option value="EU">EU</option>
                                        <option value="CA">Canada</option>
                                        <option value="APAC">Asia Pacific</option>
                                    </select>
                                </div>
                                <div class="filter-actions">
                                    <button class="btn btn-secondary btn-sm" @click="copyPermalink" title="Copy link">
                                        üîó Share
                                    </button>
                                    <button class="btn btn-ghost btn-sm" @click="clearFilters" v-if="hasActiveFilters">
                                        Clear
                                    </button>
                                </div>
                            </div>
                            
                            <div class="active-filters" v-if="hasActiveFilters">
                                <span v-if="filters.search" class="filter-tag">
                                    Search: {{ filters.search }}
                                    <button @click="filters.search = ''; updateUrl()">&times;</button>
                                </span>
                                <span v-if="filters.plan" class="filter-tag">
                                    Plan: {{ filters.plan }}
                                    <button @click="filters.plan = ''; updateUrl()">&times;</button>
                                </span>
                                <span v-if="filters.datacenter" class="filter-tag">
                                    DC: {{ filters.datacenter }}
                                    <button @click="filters.datacenter = ''; updateUrl()">&times;</button>
                                </span>
                                <span v-if="filters.status" class="filter-tag">
                                    {{ filters.status === 'available' ? 'Available' : 'Out of Stock' }}
                                    <button @click="filters.status = ''; updateUrl()">&times;</button>
                                </span>
                                <span v-if="filters.region" class="filter-tag">
                                    Region: {{ filters.region }}
                                    <button @click="filters.region = ''; updateUrl()">&times;</button>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div v-if="loading && status.length === 0" class="loading">
                        <div class="spinner"></div>
                        <p>Loading inventory status...</p>
                    </div>

                    <!-- Empty State -->
                    <div v-else-if="Object.keys(filteredGroupedStatus).length === 0" class="empty-state card">
                        <h3>No results found</h3>
                        <p>Try adjusting your filters or <a href="#" @click.prevent="clearFilters">clear all filters</a></p>
                    </div>

                    <!-- Plans Grid - Grouped by base plan -->
                    <div v-else class="plans-grid">
                        <!-- Section: Orderable Plans -->
                        <div v-if="Object.keys(orderablePlans).length > 0" class="plans-section">
                            <div class="section-header">
                                <h2 class="section-title">üõí Orderable Plans</h2>
                                <span class="section-badge">{{ Object.keys(orderablePlans).length }} plans</span>
                                <button class="btn btn-ghost btn-sm" @click="toggleCollapseAll('orderable')" style="margin-left: auto;">
                                    {{ allOrderableCollapsed ? '‚ñ∂ Expand All' : '‚ñº Collapse All' }}
                                </button>
                            </div>
                            
                            <div v-for="(plan, basePlan) in orderablePlans" :key="basePlan" 
                                 class="plan-card" :class="{ collapsed: collapsedPlans[basePlan] }">
                                
                                <div class="plan-header" @click="togglePlanCollapse(basePlan)">
                                    <div class="plan-info">
                                        <div class="plan-title-row">
                                            <span class="plan-expand">‚ñº</span>
                                            <span class="plan-name">{{ plan.display_name || formatBasePlanName(basePlan) }}</span>
                                        </div>
                                        <div class="plan-code">{{ basePlan }}</div>
                                        <div class="plan-specs" v-if="plan.specs">
                                            <span class="spec-item">
                                                <span class="spec-icon">üíª</span>
                                                {{ plan.vcpu }} vCPU
                                            </span>
                                            <span class="spec-item">
                                                <span class="spec-icon">üß†</span>
                                                {{ plan.ram_gb }} GB RAM
                                            </span>
                                            <span class="spec-item">
                                                <span class="spec-icon">üíæ</span>
                                                {{ plan.storage_gb }} GB {{ plan.storage_type || 'SSD' }}
                                            </span>
                                            <span class="spec-item" v-if="plan.bandwidth_mbps">
                                                <span class="spec-icon">üåê</span>
                                                {{ plan.bandwidth_mbps }} Mbps
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="plan-actions" @click.stop>
                                        <span class="plan-price" @click="showPricing(basePlan)" title="View pricing">
                                            {{ plan.price || 'View Price' }}
                                        </span>
                                        <a :href="plan.purchase_url || `https://${subsidiary.domain}/vps/`" 
                                           target="_blank" class="plan-order">Order</a>
                                    </div>
                                </div>
                                
                                <div class="plan-summary">
                                    <span class="summary-item">
                                        <span class="summary-dot green"></span>
                                        {{ plan.available_count }} Available
                                    </span>
                                    <span class="summary-item">
                                        <span class="summary-dot red"></span>
                                        {{ plan.unavailable_count }} Out of Stock
                                    </span>
                                    <span class="summary-item" style="color: var(--text-muted);">
                                        {{ plan.datacenters.length }} datacenters
                                    </span>
                                </div>
                                
                                <div class="plan-datacenters" v-show="!collapsedPlans[basePlan]">
                                    <div v-for="dc in plan.datacenters" :key="dc.datacenter"
                                         class="dc-card" 
                                         :class="{ 
                                             available: dc.is_available, 
                                             unavailable: !dc.is_available,
                                             highlighted: filters.datacenter === dc.datacenter
                                         }"
                                         @click="filterByDatacenter(dc.datacenter)">
                                        
                                        <div class="dc-header">
                                            <span class="dc-name">
                                                {{ dc.location_flag || 'üåê' }} {{ dc.location_display_name || dc.location_city || dc.datacenter }}
                                            </span>
                                            <a :href="'#/datacenter?dc=' + encodeURIComponent(dc.datacenter)" 
                                               class="dc-link" @click.stop title="View all plans">üìã</a>
                                        </div>
                                        
                                        <div class="dc-location" v-if="dc.location_country">
                                            {{ dc.location_country }}
                                        </div>
                                        <div class="dc-code">{{ dc.datacenter }}</div>
                                        
                                        <div class="dc-status" :class="{ available: dc.is_available, unavailable: !dc.is_available }">
                                            {{ dc.is_available ? '‚úì Available' : '‚úó Out of Stock' }}
                                        </div>
                                        
                                        <div class="dc-details">
                                            <span>üêß {{ dc.linux_status }}</span>
                                        </div>
                                        
                                        <div v-if="!dc.is_available && dc.out_of_stock_minutes > 1" class="dc-outage">
                                            ‚è± Out for {{ formatDuration(dc.out_of_stock_minutes) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section: Legacy Plans -->
                        <div v-if="Object.keys(internalPlans).length > 0" class="plans-section internal-section">
                            <div class="section-header" style="cursor: pointer;">
                                <div style="display: flex; align-items: center; gap: 12px;" @click="showInternalPlans = !showInternalPlans">
                                    <span class="plan-expand" :style="{ transform: showInternalPlans ? 'rotate(0)' : 'rotate(-90deg)' }">‚ñº</span>
                                    <h2 class="section-title">üì¶ Legacy Plans</h2>
                                    <span class="section-badge muted">{{ Object.keys(internalPlans).length }} plans</span>
                                </div>
                                <button v-if="showInternalPlans" class="btn btn-ghost btn-sm" @click.stop="toggleCollapseAll('internal')" style="margin-left: auto;">
                                    {{ allInternalCollapsed ? '‚ñ∂ Expand All' : '‚ñº Collapse All' }}
                                </button>
                                <span class="section-hint" @click="showInternalPlans = !showInternalPlans">Older plans not available for new orders</span>
                            </div>
                            
                            <div v-show="showInternalPlans">
                                <div v-for="(plan, basePlan) in internalPlans" :key="basePlan" 
                                     class="plan-card internal" :class="{ collapsed: collapsedPlans[basePlan] }">
                                    
                                    <div class="plan-header" @click="togglePlanCollapse(basePlan)">
                                        <div class="plan-info">
                                            <div class="plan-title-row">
                                                <span class="plan-expand">‚ñº</span>
                                                <span class="plan-name">{{ plan.display_name || formatBasePlanName(basePlan) }}</span>
                                                <span class="badge badge-muted" style="margin-left: 8px;">Website Only</span>
                                            </div>
                                            <div class="plan-code">{{ basePlan }}</div>
                                            <div class="plan-specs" v-if="plan.specs">
                                                <span class="spec-item">
                                                    <span class="spec-icon">üíª</span>
                                                    {{ plan.vcpu }} vCPU
                                                </span>
                                                <span class="spec-item">
                                                    <span class="spec-icon">üß†</span>
                                                    {{ plan.ram_gb }} GB RAM
                                                </span>
                                                <span class="spec-item">
                                                    <span class="spec-icon">üíæ</span>
                                                    {{ plan.storage_gb }} GB {{ plan.storage_type || 'SSD' }}
                                                </span>
                                                <span class="spec-item" v-if="plan.bandwidth_mbps">
                                                    <span class="spec-icon">üåê</span>
                                                    {{ plan.bandwidth_mbps }} Mbps
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div class="plan-actions" @click.stop>
                                            <span class="plan-price muted" @click="showPricing(basePlan)" title="View pricing">
                                                {{ plan.price || 'View Price' }}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="plan-summary">
                                        <span class="summary-item">
                                            <span class="summary-dot green"></span>
                                            {{ plan.available_count }} Available
                                        </span>
                                        <span class="summary-item">
                                            <span class="summary-dot red"></span>
                                            {{ plan.unavailable_count }} Out of Stock
                                        </span>
                                        <span class="summary-item" style="color: var(--text-muted);">
                                            {{ plan.datacenters.length }} datacenters
                                        </span>
                                    </div>
                                    
                                    <div class="plan-datacenters" v-show="!collapsedPlans[basePlan]">
                                        <div v-for="dc in plan.datacenters" :key="dc.datacenter"
                                             class="dc-card" 
                                             :class="{ 
                                                 available: dc.is_available, 
                                                 unavailable: !dc.is_available,
                                                 highlighted: filters.datacenter === dc.datacenter
                                             }"
                                             @click="filterByDatacenter(dc.datacenter)">
                                            
                                            <div class="dc-header">
                                                <span class="dc-name">
                                                    {{ dc.location_flag || 'üåê' }} {{ dc.location_display_name || dc.location_city || dc.datacenter }}
                                                </span>
                                                <a :href="'#/datacenter?dc=' + encodeURIComponent(dc.datacenter)" 
                                                   class="dc-link" @click.stop title="View all plans">üìã</a>
                                            </div>
                                            
                                            <div class="dc-location" v-if="dc.location_country">
                                                {{ dc.location_country }}
                                            </div>
                                            <div class="dc-code">{{ dc.datacenter }}</div>
                                            
                                            <div class="dc-status" :class="{ available: dc.is_available, unavailable: !dc.is_available }">
                                                {{ dc.is_available ? '‚úì Available' : '‚úó Out of Stock' }}
                                            </div>
                                            
                                            <div class="dc-details">
                                                <span>üêß {{ dc.linux_status }}</span>
                                            </div>
                                            
                                            <div v-if="!dc.is_available && dc.out_of_stock_minutes > 1" class="dc-outage">
                                                ‚è± Out for {{ formatDuration(dc.out_of_stock_minutes) }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Datacenter Tab -->
                <div v-if="activeTab === 'datacenter'">
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-body">
                            <div class="filters-row">
                                <div class="filter-group" style="flex: 1;">
                                    <label>Select Datacenter</label>
                                    <select class="filter-select" v-model="selectedDatacenter" style="width: 100%;">
                                        <option value="">Choose a datacenter...</option>
                                        <option v-for="dc in availableDatacenters" :key="dc" :value="dc">{{ dc }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- No datacenter selected -->
                    <div v-if="!selectedDatacenter" class="empty-state card">
                        <h3>üåç Select a Datacenter</h3>
                        <p>Choose a datacenter above to see all available plans and their stock status.</p>
                    </div>

                    <!-- Datacenter Info -->
                    <div v-else-if="datacenterInfo">
                        <div class="card" style="margin-bottom: 24px;">
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                                    <div>
                                        <h2 style="font-size: 1.5rem; margin-bottom: 8px;">
                                            {{ datacenterInfo.location_flag || 'üåê' }} {{ datacenterInfo.location_display_name || datacenterInfo.location_city || datacenterInfo.datacenter }}
                                        </h2>
                                        <div style="color: var(--text-secondary);">
                                            <span v-if="datacenterInfo.location_country">{{ datacenterInfo.location_country }} ‚Ä¢ </span>
                                            <code style="background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px;">{{ datacenterInfo.datacenter }}</code>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 24px;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: 600; color: var(--success);">{{ datacenterInfo.available }}</div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Available</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: 600; color: var(--danger);">{{ datacenterInfo.unavailable }}</div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Out of Stock</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: 600; color: var(--text-secondary);">{{ datacenterInfo.total }}</div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Total Plans</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Plans Table -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Plans in {{ selectedDatacenter }}</span>
                            </div>
                            <div class="table-wrapper" style="max-height: none;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Plan</th>
                                            <th>Specs</th>
                                            <th>Price</th>
                                            <th>Status</th>
                                            <th>Orderable</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="plan in datacenterPlans" :key="plan.plan_code">
                                            <td>
                                                <div style="font-weight: 500;">{{ plan.display_name_clean || formatBasePlanName(plan.base_plan) }}</div>
                                                <div style="font-size: 0.75rem; color: var(--text-muted);">{{ plan.plan_code }}</div>
                                            </td>
                                            <td>
                                                <div v-if="plan.specs" style="font-size: 0.8rem;">
                                                    <span>{{ plan.vcpu }} vCPU</span> ‚Ä¢ 
                                                    <span>{{ plan.ram_gb }} GB RAM</span> ‚Ä¢ 
                                                    <span>{{ plan.storage_gb }} GB {{ plan.storage_type || 'SSD' }}</span>
                                                </div>
                                                <span v-else style="color: var(--text-muted);">‚Äî</span>
                                            </td>
                                            <td>
                                                <span v-if="plan.price" style="color: var(--accent); font-weight: 500;">{{ plan.price }}</span>
                                                <span v-else style="color: var(--text-muted);">‚Äî</span>
                                            </td>
                                            <td>
                                                <span class="badge" :class="plan.is_available ? 'badge-success' : 'badge-danger'">
                                                    {{ plan.is_available ? '‚úì Available' : '‚úó Out of Stock' }}
                                                </span>
                                            </td>
                                            <td>
                                                <span v-if="plan.is_orderable" class="badge badge-info">üõí Yes</span>
                                                <span v-else class="badge badge-muted">üì¶ Internal</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div v-if="activeTab === 'history'">
                    <div v-if="!isAuthenticated" class="empty-state card">
                        <h3>üìä Status History</h3>
                        <p>Sign in to view detailed status history.</p>
                        <button class="btn btn-primary" @click="showLoginModal = true" style="margin-top: 16px;">
                            Login to Continue
                        </button>
                    </div>
                    <div v-else class="card">
                        <div class="card-header">
                            <span class="card-title">Status History</span>
                            <div style="display: flex; gap: 12px;">
                                <select class="filter-select" v-model="historyFilters.plan" @change="fetchHistory" style="width: auto;">
                                    <option value="">All Plans</option>
                                    <option v-for="p in availablePlans" :key="p" :value="p">{{ p }}</option>
                                </select>
                                <select class="filter-select" v-model="historyFilters.limit" @change="fetchHistory" style="width: auto;">
                                    <option :value="50">50</option>
                                    <option :value="100">100</option>
                                    <option :value="250">250</option>
                                    <option :value="500">500</option>
                                </select>
                            </div>
                        </div>
                        <div v-if="historyLoading" class="loading">
                            <div class="spinner"></div>
                        </div>
                        <div v-else class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Plan</th>
                                        <th>Datacenter</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in history" :key="item.checked_at + item.plan_code + item.datacenter">
                                        <td>{{ formatDate(item.checked_at) }}</td>
                                        <td>
                                            <a :href="'#/status?plan=' + encodeURIComponent(item.plan_code)">
                                                {{ item.plan_code }}
                                            </a>
                                        </td>
                                        <td>
                                            <a :href="'#/status?datacenter=' + encodeURIComponent(item.datacenter)">
                                                {{ item.datacenter }}
                                            </a>
                                        </td>
                                        <td>
                                            <span class="badge" :class="item.is_available ? 'badge-success' : 'badge-danger'">
                                                {{ item.is_available ? 'Available' : 'Out of Stock' }}
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Notifications Tab -->
                <div v-if="activeTab === 'notifications'">
                    <div v-if="!isAuthenticated" class="empty-state card">
                        <h3>üîî Notification History</h3>
                        <p>Sign in to view notification history.</p>
                        <button class="btn btn-primary" @click="showLoginModal = true" style="margin-top: 16px;">
                            Login to Continue
                        </button>
                    </div>
                    <div v-else class="card">
                        <div class="card-header">
                            <span class="card-title">Notification History</span>
                        </div>
                        <div v-if="notificationsLoading" class="loading">
                            <div class="spinner"></div>
                        </div>
                        <div v-else-if="notifications.length === 0" class="empty-state">
                            <h3>No notifications yet</h3>
                            <p>Notifications appear when items return to stock after 60+ minutes unavailability.</p>
                        </div>
                        <div v-else class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Plan</th>
                                        <th>Datacenter</th>
                                        <th>Message</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in notifications" :key="item.sent_at + item.plan_code">
                                        <td>{{ formatDate(item.sent_at) }}</td>
                                        <td>
                                            <a :href="'#/status?plan=' + encodeURIComponent(item.plan_code)">
                                                {{ item.plan_code }}
                                            </a>
                                        </td>
                                        <td>{{ item.datacenter }}</td>
                                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                                            {{ item.message }}
                                        </td>
                                        <td>
                                            <span class="badge" :class="item.success ? 'badge-success' : 'badge-danger'">
                                                {{ item.success ? 'Sent' : 'Failed' }}
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Admin Tab (User Management) -->
                <div v-if="activeTab === 'admin'">
                    <div v-if="!isAdmin" class="alert alert-danger">
                        You must be logged in as an admin to access this page.
                    </div>
                    <template v-else>
                        <!-- Admin Settings Card -->
                        <div class="card" style="margin-bottom: 24px;">
                            <div class="card-header">
                                <span class="card-title">‚öôÔ∏è Admin Settings</span>
                            </div>
                            <div class="card-body">
                                <div v-if="adminSettingsMessage" class="alert" :class="adminSettingsSuccess ? 'alert-success' : 'alert-danger'">
                                    {{ adminSettingsMessage }}
                                </div>
                                
                                <!-- OVH Subsidiary Setting -->
                                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color);">
                                    <h4 style="margin-bottom: 12px; font-size: 14px; font-weight: 600;">üåç OVH Subsidiary Region</h4>
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <select v-model="selectedSubsidiary" @change="updateSubsidiary" class="filter-select" style="width: 250px;">
                                            <option v-for="sub in availableSubsidiaries" :key="sub.code" :value="sub.code">
                                                {{ sub.flag }} {{ sub.name }} ({{ sub.code }})
                                            </option>
                                        </select>
                                        <span v-if="subsidiaryUpdating" class="spinner-sm"></span>
                                    </div>
                                    <p class="form-hint">Select which OVH subsidiary's catalog to monitor. Different subsidiaries have different datacenter availability.</p>
                                </div>
                                
                                <!-- Registration Setting -->
                                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" v-model="allowRegistration" @change="toggleRegistration">
                                        <span>Allow Public Registration</span>
                                    </label>
                                    <span class="badge" :class="allowRegistration ? 'badge-success' : 'badge-danger'">
                                        {{ allowRegistration ? 'Enabled' : 'Disabled' }}
                                    </span>
                                </div>
                                <p class="form-hint">When disabled, only admins can create new user accounts.</p>
                            </div>
                        </div>

                        <!-- User Management Card -->
                        <div class="card" style="margin-bottom: 24px;">
                            <div class="card-header">
                                <span class="card-title">üë• User Management</span>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span class="badge badge-info">{{ adminUsers.length }} users</span>
                                    <button class="btn btn-primary btn-sm" @click="showCreateUserModal = true">
                                        + Create User
                                    </button>
                                </div>
                            </div>
                            <div class="table-wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Email</th>
                                            <th>Username</th>
                                            <th>Status</th>
                                            <th>Role</th>
                                            <th>Created</th>
                                            <th>Last Login</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="user in adminUsers" :key="user.id">
                                            <td>{{ user.id }}</td>
                                            <td>{{ user.email }}</td>
                                            <td>{{ user.username }}</td>
                                            <td>
                                                <span class="badge" :class="user.is_active ? 'badge-success' : 'badge-danger'">
                                                    {{ user.is_active ? 'Active' : 'Disabled' }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge" :class="user.is_admin ? 'badge-purple' : 'badge-muted'">
                                                    {{ user.is_admin ? 'Admin' : 'User' }}
                                                </span>
                                            </td>
                                            <td>{{ formatDate(user.created_at) }}</td>
                                            <td>{{ user.last_login ? formatDate(user.last_login) : 'Never' }}</td>
                                            <td>
                                                <div style="display: flex; gap: 4px;">
                                                    <button class="btn btn-ghost btn-sm" 
                                                            @click="toggleUserActive(user)"
                                                            :disabled="user.id === currentUser?.id"
                                                            :title="user.is_active ? 'Disable User' : 'Enable User'">
                                                        {{ user.is_active ? 'üö´' : '‚úÖ' }}
                                                    </button>
                                                    <button class="btn btn-ghost btn-sm" 
                                                            @click="toggleUserAdmin(user)"
                                                            :disabled="user.id === currentUser?.id"
                                                            :title="user.is_admin ? 'Remove Admin' : 'Make Admin'">
                                                        {{ user.is_admin ? 'üë§' : 'üëë' }}
                                                    </button>
                                                    <button class="btn btn-ghost btn-sm" 
                                                            @click="confirmDeleteUser(user)"
                                                            :disabled="user.id === currentUser?.id"
                                                            title="Delete User">
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Groups Management Card -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">üè¢ Groups</span>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span class="badge badge-info">{{ adminGroups.length }} groups</span>
                                    <button class="btn btn-primary btn-sm" @click="showCreateGroupModal = true">
                                        + Create Group
                                    </button>
                                </div>
                            </div>
                            <div class="table-wrapper" v-if="adminGroups.length > 0">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Description</th>
                                            <th>Members</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="group in adminGroups" :key="group.id">
                                            <td>{{ group.id }}</td>
                                            <td>{{ group.name }}</td>
                                            <td>{{ group.description || '-' }}</td>
                                            <td>
                                                <button class="btn btn-ghost btn-sm" @click="showGroupMembers(group)">
                                                    {{ group.member_count || 0 }} members
                                                </button>
                                            </td>
                                            <td>{{ formatDate(group.created_at) }}</td>
                                            <td>
                                                <div style="display: flex; gap: 4px;">
                                                    <button class="btn btn-ghost btn-sm" @click="editGroup(group)" title="Edit Group">
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button class="btn btn-ghost btn-sm" @click="confirmDeleteGroup(group)" title="Delete Group">
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div v-else class="card-body">
                                <p style="text-align: center; color: var(--text-muted);">No groups yet. Create one to get started.</p>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Settings Tab -->
                <div v-if="activeTab === 'settings'">
                    <div v-if="!isAdmin" class="alert alert-danger">
                        You must be logged in as an admin to access settings.
                    </div>
                    <template v-else>
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-header">
                            <span class="card-title">Default Discord Webhook</span>
                        </div>
                        <div class="card-body">
                            <div v-if="alertMessage" class="alert" :class="alertType === 'success' ? 'alert-success' : 'alert-danger'">
                                {{ alertMessage }}
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Webhook URL</label>
                                <input type="text" class="form-input" v-model="webhookUrl" 
                                       placeholder="https://discord.com/api/webhooks/...">
                                <p class="form-hint" v-if="config.discord_webhook_url_masked">
                                    Current: {{ config.discord_webhook_url_masked }}
                                </p>
                                <p class="form-hint">This is the default webhook that receives all stock notifications.</p>
                            </div>
                            
                            <div style="display: flex; gap: 12px;">
                                <button class="btn btn-primary" @click="saveWebhook" :disabled="saving">
                                    {{ saving ? 'Saving...' : 'Save Webhook' }}
                                </button>
                                <button class="btn btn-secondary" @click="testWebhook" :disabled="testing">
                                    {{ testing ? 'Testing...' : 'Test Webhook' }}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Monitored Plans</span>
                            <span class="badge badge-info">{{ plans.length }} plans</span>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Plan Code</th>
                                        <th>Name</th>
                                        <th>Specs</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="plan in plans" :key="plan.plan_code">
                                        <td>
                                            <a :href="'#/status?plan=' + encodeURIComponent(plan.plan_code)">
                                                {{ plan.plan_code }}
                                            </a>
                                        </td>
                                        <td>{{ plan.display_name }}</td>
                                        <td>{{ plan.specs || '‚Äî' }}</td>
                                        <td>{{ plan.price || '‚Äî' }}</td>
                                        <td>
                                            <span class="badge" :class="plan.enabled ? 'badge-success' : 'badge-danger'">
                                                {{ plan.enabled ? 'Enabled' : 'Disabled' }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm" 
                                                    :class="plan.enabled ? 'btn-danger' : 'btn-success'"
                                                    @click="togglePlanEnabled(plan)">
                                                {{ plan.enabled ? 'Disable' : 'Enable' }}
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    </template>
                </div>

                <!-- My Alerts Tab (User Subscriptions) -->
                <div v-if="activeTab === 'my-alerts'">
                    <div v-if="!isAuthenticated" class="empty-state card">
                        <h3>üîî Personal Alerts</h3>
                        <p>Sign in to set up personalized Discord notifications for specific plans.</p>
                        <button class="btn btn-primary" @click="showLoginModal = true" style="margin-top: 16px;">
                            Login to Continue
                        </button>
                    </div>
                    
                    <template v-else>
                        <!-- User Webhooks Section -->
                        <div class="card" style="margin-bottom: 24px;">
                            <div class="card-header">
                                <span class="card-title">üîó My Discord Webhooks</span>
                                <button class="btn btn-primary btn-sm" @click="showAddWebhookModal = true">
                                    + Add Webhook
                                </button>
                            </div>
                            <div class="card-body">
                                <div v-if="userWebhooks.length === 0" class="empty-state" style="padding: 24px;">
                                    <p>No webhooks configured. Add a Discord webhook to receive personal notifications.</p>
                                </div>
                                <div v-else>
                                    <div v-for="wh in userWebhooks" :key="wh.id" 
                                         style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
                                        <div>
                                            <div style="font-weight: 500;">{{ wh.webhook_name }}</div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted);">{{ wh.webhook_url_masked }}</div>
                                        </div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <span class="badge" :class="wh.is_active ? 'badge-success' : 'badge-muted'">
                                                {{ wh.is_active ? 'Active' : 'Disabled' }}
                                            </span>
                                            <button class="btn btn-ghost btn-sm" @click="testUserWebhook(wh.id)" title="Test">üì§</button>
                                            <button class="btn btn-ghost btn-sm" @click="toggleUserWebhook(wh)" title="Toggle">
                                                {{ wh.is_active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è' }}
                                            </button>
                                            <button class="btn btn-ghost btn-sm" @click="deleteUserWebhook(wh.id)" title="Delete">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Plan Subscriptions Section -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">üìã Plan Subscriptions</span>
                                <span class="badge badge-info">{{ userSubscriptions.length }} subscribed</span>
                            </div>
                            <div class="card-body">
                                <p style="color: var(--text-secondary); margin-bottom: 16px;">
                                    Select which plans you want to receive personal Discord notifications for when they come back in stock.
                                </p>
                                
                                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                                    <button class="btn btn-secondary btn-sm" @click="selectAllPlans">Select All</button>
                                    <button class="btn btn-secondary btn-sm" @click="deselectAllPlans">Deselect All</button>
                                    <button class="btn btn-primary btn-sm" @click="saveSubscriptions" :disabled="savingSubscriptions">
                                        {{ savingSubscriptions ? 'Saving...' : 'Save Changes' }}
                                    </button>
                                </div>

                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                                    <div v-for="plan in allPlansForSubscription" :key="plan.plan_code"
                                         class="dc-card" :class="{ available: selectedPlans[plan.plan_code] }"
                                         @click="togglePlanSubscription(plan.plan_code)"
                                         style="cursor: pointer;">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                            <div>
                                                <div style="font-weight: 500;">{{ plan.display_name || plan.plan_code }}</div>
                                                <div style="font-size: 0.75rem; color: var(--text-muted);">{{ plan.plan_code }}</div>
                                                <div v-if="plan.specs" style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">
                                                    {{ plan.specs }}
                                                </div>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span v-if="plan.price" style="color: var(--accent); font-size: 0.875rem;">{{ plan.price }}</span>
                                                <input type="checkbox" 
                                                       :checked="selectedPlans[plan.plan_code]"
                                                       @click.stop="togglePlanSubscription(plan.plan_code)"
                                                       style="width: 18px; height: 18px; cursor: pointer;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- My Notification History -->
                        <div class="card" style="margin-top: 24px;">
                            <div class="card-header">
                                <span class="card-title">üìú My Notification History</span>
                            </div>
                            <div v-if="userNotifications.length === 0" class="empty-state" style="padding: 40px;">
                                <p>No notifications sent yet.</p>
                            </div>
                            <div v-else class="table-wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Plan</th>
                                            <th>Datacenter</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="item in userNotifications" :key="item.id">
                                            <td>{{ formatDate(item.sent_at) }}</td>
                                            <td>{{ item.plan_code }}</td>
                                            <td>{{ item.datacenter }}</td>
                                            <td>
                                                <span class="badge" :class="item.success ? 'badge-success' : 'badge-danger'">
                                                    {{ item.success ? 'Sent' : 'Failed' }}
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </main>

        <!-- Pricing Modal -->
        <div v-if="pricingModal.visible" class="modal-overlay" @click.self="pricingModal.visible = false">
            <div class="modal">
                <div class="modal-header">
                    <span class="modal-title">{{ pricingModal.planCode }} Pricing</span>
                    <button class="modal-close" @click="pricingModal.visible = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div v-if="pricingModal.loading" class="loading" style="padding: 40px;">
                        <div class="spinner"></div>
                    </div>
                    <div v-else-if="pricingModal.tiers.length === 0">
                        <p style="color: var(--text-muted);">No pricing data available.</p>
                    </div>
                    <div v-else>
                        <div v-for="tier in pricingModal.tiers" :key="tier.commitment_months"
                             class="pricing-tier" :class="{ best: tier.commitment_months === 12 }">
                            <div class="pricing-label">
                                {{ tier.commitment_months === 0 ? 'No Commitment' : tier.commitment_months + ' Month' }}
                                <small v-if="tier.commitment_months === 12">Best Value</small>
                            </div>
                            <div class="pricing-value">{{ tier.price }}</div>
                        </div>
                        <p class="pricing-note">
                            Prices from OVH Catalog API<br>
                            Last updated: {{ pricingModal.lastUpdated || 'Unknown' }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div v-if="toast.visible" class="toast">{{ toast.message }}</div>
        
        <!-- Refresh Indicator -->
        <div class="refresh-indicator" :class="{ visible: isRefreshing }">
            <span class="mini-spinner"></span>
            <span>Updating...</span>
        </div>

        <!-- Login Modal -->
        <div v-if="showLoginModal" class="modal-overlay" @click.self="showLoginModal = false">
            <div class="modal">
                <div class="modal-header">
                    <span class="modal-title">Login</span>
                    <button class="modal-close" @click="showLoginModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div v-if="authError" class="alert alert-danger">{{ authError }}</div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" v-model="loginForm.email" 
                               placeholder="you@example.com" @keyup.enter="handleLogin">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" v-model="loginForm.password" 
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" @keyup.enter="handleLogin">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" @click="handleLogin" :disabled="authLoading">
                        {{ authLoading ? 'Logging in...' : 'Login' }}
                    </button>
                    <p style="text-align: center; margin-top: 16px; color: var(--text-muted);">
                        Don't have an account? 
                        <a href="#" @click.prevent="showLoginModal = false; showRegisterModal = true;">Sign up</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Register Modal -->
        <div v-if="showRegisterModal" class="modal-overlay" @click.self="showRegisterModal = false">
            <div class="modal">
                <div class="modal-header">
                    <span class="modal-title">Create Account</span>
                    <button class="modal-close" @click="showRegisterModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div v-if="authError" class="alert alert-danger">{{ authError }}</div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" v-model="registerForm.email" 
                               placeholder="you@example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-input" v-model="registerForm.username" 
                               placeholder="johndoe">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" v-model="registerForm.password" 
                               placeholder="At least 8 characters">
                        <p class="form-hint">Must be at least 8 characters</p>
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" @click="handleRegister" :disabled="authLoading">
                        {{ authLoading ? 'Creating account...' : 'Create Account' }}
                    </button>
                    <p style="text-align: center; margin-top: 16px; color: var(--text-muted);">
                        Already have an account? 
                        <a href="#" @click.prevent="showRegisterModal = false; showLoginModal = true;">Login</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Add Webhook Modal -->
        <div v-if="showAddWebhookModal" class="modal-overlay" @click.self="showAddWebhookModal = false">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <span class="modal-title">Add Discord Webhook</span>
                    <button class="modal-close" @click="showAddWebhookModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div v-if="webhookError" class="alert alert-danger">{{ webhookError }}</div>
                    <div class="form-group">
                        <label class="form-label">Webhook Name *</label>
                        <input type="text" class="form-input" v-model="newWebhookForm.name" 
                               placeholder="My Discord Server">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Webhook URL *</label>
                        <input type="text" class="form-input" v-model="newWebhookForm.url" 
                               placeholder="https://discord.com/api/webhooks/...">
                        <p class="form-hint">Get this from Discord Server Settings ‚Üí Integrations ‚Üí Webhooks</p>
                    </div>
                    
                    <hr style="border: 0; border-top: 1px solid var(--border); margin: 16px 0;">
                    <h4 style="margin-bottom: 12px; color: var(--text-secondary);">üé® Discord Customization (Optional)</h4>
                    
                    <div class="form-group">
                        <label class="form-label">Bot Username</label>
                        <input type="text" class="form-input" v-model="newWebhookForm.bot_username" 
                               placeholder="OVH Stock Alert">
                        <p class="form-hint">Override the webhook's default username</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Avatar URL</label>
                        <input type="text" class="form-input" v-model="newWebhookForm.avatar_url" 
                               placeholder="https://example.com/avatar.png">
                        <p class="form-hint">Override the webhook's default avatar</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Embed Color</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="color" v-model="webhookColorPicker" @input="newWebhookForm.embed_color = webhookColorPicker.replace('#', '')" 
                                   style="width: 50px; height: 38px; border: none; background: none; cursor: pointer;">
                            <input type="text" class="form-input" v-model="newWebhookForm.embed_color" 
                                   placeholder="3FB950" style="flex: 1;">
                        </div>
                        <p class="form-hint">Hex color code without # (e.g., 3FB950 for green)</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mention Role ID</label>
                        <input type="text" class="form-input" v-model="newWebhookForm.mention_role_id" 
                               placeholder="123456789012345678">
                        <p class="form-hint">Discord role ID to mention when stock is available</p>
                    </div>
                    
                    <div style="display: flex; gap: 16px; margin-top: 16px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" v-model="newWebhookForm.include_price">
                            <span>Include Price</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" v-model="newWebhookForm.include_specs">
                            <span>Include Specs</span>
                        </label>
                    </div>
                    
                    <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" @click="handleAddWebhook" :disabled="addingWebhook">
                        {{ addingWebhook ? 'Adding...' : 'Add Webhook' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Create User Modal (Admin) -->
        <div v-if="showCreateUserModal" class="modal-overlay" @click.self="showCreateUserModal = false">
            <div class="modal">
                <div class="modal-header">
                    <span class="modal-title">Create New User</span>
                    <button class="modal-close" @click="showCreateUserModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div v-if="createUserError" class="alert alert-danger">{{ createUserError }}</div>
                    <div v-if="createUserSuccess" class="alert alert-success">{{ createUserSuccess }}</div>
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-input" v-model="createUserForm.email" 
                               placeholder="user@example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Username *</label>
                        <input type="text" class="form-input" v-model="createUserForm.username" 
                               placeholder="johndoe">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-input" v-model="createUserForm.password" 
                               placeholder="At least 8 characters">
                    </div>
                    <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" v-model="createUserForm.is_active">
                            <span>Active</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" v-model="createUserForm.is_admin">
                            <span>Admin</span>
                        </label>
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" @click="handleCreateUser" :disabled="creatingUser">
                        {{ creatingUser ? 'Creating...' : 'Create User' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Create Group Modal (Admin) -->
        <div v-if="showCreateGroupModal" class="modal-overlay" @click.self="showCreateGroupModal = false">
            <div class="modal">
                <div class="modal-header">
                    <span class="modal-title">Create New Group</span>
                    <button class="modal-close" @click="showCreateGroupModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div v-if="groupError" class="alert alert-danger">{{ groupError }}</div>
                    <div class="form-group">
                        <label class="form-label">Group Name *</label>
                        <input type="text" class="form-input" v-model="createGroupForm.name" 
                               placeholder="Engineering Team">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" v-model="createGroupForm.description" 
                                  placeholder="Optional description" rows="3"></textarea>
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" @click="handleCreateGroup" :disabled="savingGroup">
                        {{ savingGroup ? 'Creating...' : 'Create Group' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Group Modal (Admin) -->
        <div v-if="showEditGroupModal" class="modal-overlay" @click.self="showEditGroupModal = false">
            <div class="modal">
                <div class="modal-header">
                    <span class="modal-title">Edit Group</span>
                    <button class="modal-close" @click="showEditGroupModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div v-if="groupError" class="alert alert-danger">{{ groupError }}</div>
                    <div class="form-group">
                        <label class="form-label">Group Name *</label>
                        <input type="text" class="form-input" v-model="editGroupForm.name" 
                               placeholder="Engineering Team">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" v-model="editGroupForm.description" 
                                  placeholder="Optional description" rows="3"></textarea>
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" @click="handleUpdateGroup" :disabled="savingGroup">
                        {{ savingGroup ? 'Saving...' : 'Save Changes' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Group Members Modal (Admin) -->
        <div v-if="showGroupMembersModal" class="modal-overlay" @click.self="showGroupMembersModal = false">
            <div class="modal" style="max-width: 600px;">
                <div class="modal-header">
                    <span class="modal-title">Members of {{ selectedGroup?.name }}</span>
                    <button class="modal-close" @click="showGroupMembersModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <div v-if="groupMembersError" class="alert alert-danger">{{ groupMembersError }}</div>
                    
                    <!-- Add Member Form -->
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <select class="form-input" v-model="addMemberUserId" style="flex: 1;">
                            <option value="">Select user to add...</option>
                            <option v-for="user in availableUsersForGroup" :key="user.id" :value="user.id">
                                {{ user.username }} ({{ user.email }})
                            </option>
                        </select>
                        <select class="form-input" v-model="addMemberRole" style="width: 120px;">
                            <option value="member">Member</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button class="btn btn-primary" @click="handleAddGroupMember" :disabled="!addMemberUserId || addingMember">
                            {{ addingMember ? '...' : 'Add' }}
                        </button>
                    </div>
                    
                    <!-- Members List -->
                    <div v-if="groupMembers.length > 0">
                        <div v-for="member in groupMembers" :key="member.user_id" 
                             style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 8px;">
                            <div>
                                <strong>{{ member.username }}</strong>
                                <span style="color: var(--text-muted); margin-left: 8px;">{{ member.email }}</span>
                                <span class="badge" :class="member.role === 'admin' ? 'badge-purple' : 'badge-muted'" style="margin-left: 8px;">
                                    {{ member.role }}
                                </span>
                            </div>
                            <button class="btn btn-ghost btn-sm" @click="handleRemoveGroupMember(member)" title="Remove from group">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    <p v-else style="text-align: center; color: var(--text-muted);">No members in this group yet.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const { createApp, ref, computed, onMounted, watch, onUnmounted } = Vue;

        // Auth helper functions
        const getStoredTokens = () => {
            try {
                return {
                    accessToken: localStorage.getItem('access_token'),
                    refreshToken: localStorage.getItem('refresh_token')
                };
            } catch {
                return { accessToken: null, refreshToken: null };
            }
        };

        const storeTokens = (accessToken, refreshToken) => {
            localStorage.setItem('access_token', accessToken);
            localStorage.setItem('refresh_token', refreshToken);
        };

        const clearTokens = () => {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
        };

        const parseJwt = (token) => {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(window.atob(base64));
            } catch {
                return null;
            }
        };

        // Get base plan name (strip regional suffix and Local Zone suffix)
        const getBasePlanName = (planCode) => {
            // Remove Local Zone suffix first (.LZ, .LZ-eu, .LZ-ca)
            let base = planCode.replace(/\.LZ(-[a-z]+)?$/i, '');
            // Remove regional suffixes like -us, -eu, -ca, -apac
            base = base.replace(/-(us|eu|ca|apac)$/i, '');
            return base;
        };

        createApp({
            setup() {
                const activeTab = ref('status');
                const loading = ref(true);
                const historyLoading = ref(false);
                const notificationsLoading = ref(false);
                const isRefreshing = ref(false);
                const saving = ref(false);
                const testing = ref(false);
                
                // Auth state
                const isAuthenticated = ref(false);
                const isAdmin = ref(false);
                const currentUser = ref(null);
                const authLoading = ref(false);
                const authError = ref('');
                const showLoginModal = ref(false);
                const showRegisterModal = ref(false);
                const showAddWebhookModal = ref(false);
                const webhookError = ref('');
                const addingWebhook = ref(false);
                
                const loginForm = ref({ email: '', password: '' });
                const registerForm = ref({ email: '', username: '', password: '' });
                const newWebhookForm = ref({ 
                    name: 'My Discord', 
                    url: '',
                    bot_username: '',
                    avatar_url: '',
                    embed_color: '',
                    mention_role_id: '',
                    include_price: true,
                    include_specs: true
                });
                const webhookColorPicker = ref('#3FB950');
                
                // Admin modals and forms
                const showCreateUserModal = ref(false);
                const createUserForm = ref({ email: '', username: '', password: '', is_active: true, is_admin: false });
                const createUserError = ref('');
                const createUserSuccess = ref('');
                const creatingUser = ref(false);
                
                const showCreateGroupModal = ref(false);
                const showEditGroupModal = ref(false);
                const showGroupMembersModal = ref(false);
                const createGroupForm = ref({ name: '', description: '' });
                const editGroupForm = ref({ id: null, name: '', description: '' });
                const groupError = ref('');
                const savingGroup = ref(false);
                
                const selectedGroup = ref(null);
                const groupMembers = ref([]);
                const groupMembersError = ref('');
                const addMemberUserId = ref('');
                const addMemberRole = ref('member');
                const addingMember = ref(false);
                
                // Admin settings
                const allowRegistration = ref(true);
                const adminSettingsMessage = ref('');
                const adminSettingsSuccess = ref(false);
                const availableSubsidiaries = ref([]);
                const selectedSubsidiary = ref('US');
                const subsidiaryUpdating = ref(false);
                
                // Multi-subsidiary state
                const subsidiariesInfo = ref({ active: [], with_data: [], names: {} });
                const activeSubsidiary = ref('ALL');  // 'ALL' or specific code like 'US', 'FR'
                
                // Subsidiary helper functions
                const subsidiaryFlags = {
                    'US': 'üá∫üá∏', 'CA': 'üá®üá¶', 'FR': 'üá´üá∑', 'DE': 'üá©üá™', 'GB': 'üá¨üáß',
                    'ES': 'üá™üá∏', 'IT': 'üáÆüáπ', 'NL': 'üá≥üá±', 'PL': 'üáµüá±', 'PT': 'üáµüáπ',
                    'IE': 'üáÆüá™', 'AU': 'üá¶üá∫', 'SG': 'üá∏üá¨', 'ASIA': 'üåè', 'IN': 'üáÆüá≥',
                    'WE': 'üá™üá∫', 'WS': 'üåê'
                };
                
                const getSubsidiaryFlag = (code) => subsidiaryFlags[code] || 'üåê';
                
                const getSubsidiaryName = (code) => {
                    return subsidiariesInfo.value.names?.[code] || code;
                };
                
                const getSubsidiaryCount = (code) => {
                    return status.value.filter(s => s.subsidiary === code).length;
                };
                
                const subsidiariesWithData = computed(() => {
                    return subsidiariesInfo.value.with_data || [];
                });
                
                const setActiveSubsidiary = (code) => {
                    activeSubsidiary.value = code;
                };
                
                // User data
                const userWebhooks = ref([]);
                const userSubscriptions = ref([]);
                const userNotifications = ref([]);
                const selectedPlans = ref({});
                const savingSubscriptions = ref(false);
                
                // Admin data
                const adminUsers = ref([]);
                const adminGroups = ref([]);
                const adminLoading = ref(false);
                
                const status = ref([]);
                const history = ref([]);
                const notifications = ref([]);
                const plans = ref([]);
                const config = ref({});
                const subsidiary = ref({ code: 'US', name: 'OVHcloud US', domain: 'us.ovhcloud.com', flag: 'üá∫üá∏', region: 'United States' });
                const webhookUrl = ref('');
                const alertMessage = ref('');
                const alertType = ref('success');
                const collapsedPlans = ref({});
                const collapsedGroups = ref({});
                const showInternalPlans = ref(false);  // Internal plans collapsed by default
                const toast = ref({ visible: false, message: '' });
                const selectedDatacenter = ref('');
                
                let refreshInterval = null;

                const filters = ref({
                    search: '',
                    plan: '',
                    datacenter: '',
                    status: '',
                    region: ''
                });

                const historyFilters = ref({
                    plan: '',
                    limit: 100
                });

                const pricingModal = ref({
                    visible: false,
                    loading: false,
                    planCode: '',
                    tiers: [],
                    lastUpdated: ''
                });

                // Auth functions
                const getAuthHeaders = () => {
                    const { accessToken } = getStoredTokens();
                    return accessToken ? { 'Authorization': `Bearer ${accessToken}` } : {};
                };

                const checkAuth = async () => {
                    const { accessToken, refreshToken } = getStoredTokens();
                    if (!accessToken) {
                        isAuthenticated.value = false;
                        isAdmin.value = false;
                        currentUser.value = null;
                        return;
                    }

                    const payload = parseJwt(accessToken);
                    if (!payload) {
                        clearTokens();
                        isAuthenticated.value = false;
                        return;
                    }

                    // Check if token is expired
                    if (payload.exp * 1000 < Date.now()) {
                        // Try to refresh
                        if (refreshToken) {
                            try {
                                const response = await fetch(`${API_BASE}/api/auth/refresh`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ refresh_token: refreshToken })
                                });
                                if (response.ok) {
                                    const data = await response.json();
                                    storeTokens(data.access_token, data.refresh_token);
                                    const newPayload = parseJwt(data.access_token);
                                    isAuthenticated.value = true;
                                    isAdmin.value = newPayload?.is_admin || false;
                                    currentUser.value = { email: newPayload?.email };
                                    return;
                                }
                            } catch (e) {
                                console.error('Token refresh failed:', e);
                            }
                        }
                        clearTokens();
                        isAuthenticated.value = false;
                        return;
                    }

                    isAuthenticated.value = true;
                    isAdmin.value = payload.is_admin || false;
                    currentUser.value = { email: payload.email };
                };

                const handleLogin = async () => {
                    authError.value = '';
                    authLoading.value = true;
                    
                    try {
                        const response = await fetch(`${API_BASE}/api/auth/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(loginForm.value)
                        });
                        
                        if (!response.ok) {
                            const error = await response.json();
                            authError.value = error.detail || 'Login failed';
                            return;
                        }
                        
                        const data = await response.json();
                        storeTokens(data.access_token, data.refresh_token);
                        await checkAuth();
                        showLoginModal.value = false;
                        loginForm.value = { email: '', password: '' };
                        showToast('Logged in successfully!');
                        
                        // Fetch user data
                        fetchUserData();
                    } catch (e) {
                        authError.value = 'Network error. Please try again.';
                    } finally {
                        authLoading.value = false;
                    }
                };

                const handleRegister = async () => {
                    authError.value = '';
                    authLoading.value = true;
                    
                    try {
                        const response = await fetch(`${API_BASE}/api/auth/register`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(registerForm.value)
                        });
                        
                        if (!response.ok) {
                            const error = await response.json();
                            authError.value = error.detail || 'Registration failed';
                            return;
                        }
                        
                        const data = await response.json();
                        storeTokens(data.access_token, data.refresh_token);
                        await checkAuth();
                        showRegisterModal.value = false;
                        registerForm.value = { email: '', username: '', password: '' };
                        showToast('Account created successfully!');
                        
                        // Fetch user data
                        fetchUserData();
                    } catch (e) {
                        authError.value = 'Network error. Please try again.';
                    } finally {
                        authLoading.value = false;
                    }
                };

                const logout = async () => {
                    const { refreshToken } = getStoredTokens();
                    if (refreshToken) {
                        try {
                            await fetch(`${API_BASE}/api/auth/logout`, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    ...getAuthHeaders()
                                },
                                body: JSON.stringify({ refresh_token: refreshToken })
                            });
                        } catch (e) {
                            console.error('Logout API error:', e);
                        }
                    }
                    clearTokens();
                    isAuthenticated.value = false;
                    isAdmin.value = false;
                    currentUser.value = null;
                    userWebhooks.value = [];
                    userSubscriptions.value = [];
                    userNotifications.value = [];
                    showToast('Logged out');
                };

                // User data functions
                const fetchUserData = async () => {
                    if (!isAuthenticated.value) return;
                    
                    try {
                        const [webhooksRes, subsRes, notifsRes] = await Promise.all([
                            fetch(`${API_BASE}/api/me/webhooks`, { headers: getAuthHeaders() }),
                            fetch(`${API_BASE}/api/me/subscriptions`, { headers: getAuthHeaders() }),
                            fetch(`${API_BASE}/api/me/notifications?limit=50`, { headers: getAuthHeaders() })
                        ]);
                        
                        if (webhooksRes.ok) userWebhooks.value = await webhooksRes.json();
                        if (subsRes.ok) {
                            userSubscriptions.value = await subsRes.json();
                            // Initialize selectedPlans from subscriptions
                            selectedPlans.value = {};
                            userSubscriptions.value.forEach(sub => {
                                if (sub.notify_on_available) {
                                    selectedPlans.value[sub.plan_code] = true;
                                }
                            });
                        }
                        if (notifsRes.ok) userNotifications.value = await notifsRes.json();
                    } catch (e) {
                        console.error('Failed to fetch user data:', e);
                    }
                };

                const handleAddWebhook = async () => {
                    webhookError.value = '';
                    addingWebhook.value = true;
                    
                    try {
                        const payload = {
                            webhook_url: newWebhookForm.value.url,
                            webhook_name: newWebhookForm.value.name,
                            include_price: newWebhookForm.value.include_price,
                            include_specs: newWebhookForm.value.include_specs
                        };
                        
                        // Add optional fields if provided
                        if (newWebhookForm.value.bot_username) {
                            payload.bot_username = newWebhookForm.value.bot_username;
                        }
                        if (newWebhookForm.value.avatar_url) {
                            payload.avatar_url = newWebhookForm.value.avatar_url;
                        }
                        if (newWebhookForm.value.embed_color) {
                            payload.embed_color = newWebhookForm.value.embed_color;
                        }
                        if (newWebhookForm.value.mention_role_id) {
                            payload.mention_role_id = newWebhookForm.value.mention_role_id;
                        }
                        
                        const response = await fetch(`${API_BASE}/api/me/webhooks`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                ...getAuthHeaders()
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!response.ok) {
                            const error = await response.json();
                            webhookError.value = error.detail || 'Failed to add webhook';
                            return;
                        }
                        
                        showAddWebhookModal.value = false;
                        newWebhookForm.value = { 
                            name: 'My Discord', 
                            url: '',
                            bot_username: '',
                            avatar_url: '',
                            embed_color: '',
                            mention_role_id: '',
                            include_price: true,
                            include_specs: true
                        };
                        showToast('Webhook added!');
                        fetchUserData();
                    } catch (e) {
                        webhookError.value = 'Network error. Please try again.';
                    } finally {
                        addingWebhook.value = false;
                    }
                };

                const testUserWebhook = async (webhookId) => {
                    try {
                        const response = await fetch(`${API_BASE}/api/me/webhooks/${webhookId}/test`, {
                            method: 'POST',
                            headers: getAuthHeaders()
                        });
                        const result = await response.json();
                        showToast(result.success ? 'Test notification sent!' : 'Test failed: ' + result.message);
                    } catch (e) {
                        showToast('Failed to test webhook');
                    }
                };

                const toggleUserWebhook = async (wh) => {
                    try {
                        await fetch(`${API_BASE}/api/me/webhooks/${wh.id}`, {
                            method: 'PUT',
                            headers: { 
                                'Content-Type': 'application/json',
                                ...getAuthHeaders()
                            },
                            body: JSON.stringify({ is_active: !wh.is_active })
                        });
                        wh.is_active = !wh.is_active;
                        showToast(wh.is_active ? 'Webhook enabled' : 'Webhook disabled');
                    } catch (e) {
                        showToast('Failed to update webhook');
                    }
                };

                const deleteUserWebhook = async (webhookId) => {
                    if (!confirm('Delete this webhook?')) return;
                    
                    try {
                        await fetch(`${API_BASE}/api/me/webhooks/${webhookId}`, {
                            method: 'DELETE',
                            headers: getAuthHeaders()
                        });
                        userWebhooks.value = userWebhooks.value.filter(w => w.id !== webhookId);
                        showToast('Webhook deleted');
                    } catch (e) {
                        showToast('Failed to delete webhook');
                    }
                };

                const togglePlanSubscription = (planCode) => {
                    selectedPlans.value[planCode] = !selectedPlans.value[planCode];
                };

                const selectAllPlans = () => {
                    plans.value.forEach(p => {
                        selectedPlans.value[p.plan_code] = true;
                    });
                };

                const deselectAllPlans = () => {
                    selectedPlans.value = {};
                };

                const saveSubscriptions = async () => {
                    savingSubscriptions.value = true;
                    
                    try {
                        // Get list of selected plan codes
                        const selectedPlanCodes = Object.keys(selectedPlans.value).filter(k => selectedPlans.value[k]);
                        
                        await fetch(`${API_BASE}/api/me/subscriptions/bulk`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                ...getAuthHeaders()
                            },
                            body: JSON.stringify({
                                plan_codes: selectedPlanCodes,
                                notify_on_available: true
                            })
                        });
                        
                        // Remove unselected subscriptions
                        const currentSubCodes = userSubscriptions.value.map(s => s.plan_code);
                        const toRemove = currentSubCodes.filter(code => !selectedPlans.value[code]);
                        
                        for (const code of toRemove) {
                            await fetch(`${API_BASE}/api/me/subscriptions/${encodeURIComponent(code)}`, {
                                method: 'DELETE',
                                headers: getAuthHeaders()
                            });
                        }
                        
                        showToast('Subscriptions saved!');
                        fetchUserData();
                    } catch (e) {
                        showToast('Failed to save subscriptions');
                    } finally {
                        savingSubscriptions.value = false;
                    }
                };

                // Admin functions
                const fetchAdminUsers = async () => {
                    if (!isAdmin.value) return;
                    
                    adminLoading.value = true;
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/users`, {
                            headers: getAuthHeaders()
                        });
                        if (response.ok) {
                            adminUsers.value = await response.json();
                        }
                    } catch (e) {
                        console.error('Failed to fetch users:', e);
                    } finally {
                        adminLoading.value = false;
                    }
                };

                const toggleUserActive = async (user) => {
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/users/${user.id}?is_active=${!user.is_active}`, {
                            method: 'PUT',
                            headers: getAuthHeaders()
                        });
                        if (response.ok) {
                            user.is_active = !user.is_active;
                            showToast(`User ${user.is_active ? 'enabled' : 'disabled'}`);
                        } else {
                            const err = await response.json();
                            showToast(err.detail || 'Failed to update user');
                        }
                    } catch (e) {
                        showToast('Failed to update user');
                    }
                };

                const toggleUserAdmin = async (user) => {
                    const action = user.is_admin ? 'remove admin from' : 'make admin';
                    if (!confirm(`Are you sure you want to ${action} ${user.email}?`)) return;
                    
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/users/${user.id}?is_admin=${!user.is_admin}`, {
                            method: 'PUT',
                            headers: getAuthHeaders()
                        });
                        if (response.ok) {
                            user.is_admin = !user.is_admin;
                            showToast(`User is now ${user.is_admin ? 'an admin' : 'a regular user'}`);
                        } else {
                            const err = await response.json();
                            showToast(err.detail || 'Failed to update user');
                        }
                    } catch (e) {
                        showToast('Failed to update user');
                    }
                };

                const confirmDeleteUser = async (user) => {
                    if (!confirm(`Are you sure you want to DELETE ${user.email}? This cannot be undone.`)) return;
                    
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/users/${user.id}`, {
                            method: 'DELETE',
                            headers: getAuthHeaders()
                        });
                        if (response.ok) {
                            adminUsers.value = adminUsers.value.filter(u => u.id !== user.id);
                            showToast('User deleted');
                        } else {
                            const err = await response.json();
                            showToast(err.detail || 'Failed to delete user');
                        }
                    } catch (e) {
                        showToast('Failed to delete user');
                    }
                };

                // Admin Create User
                const handleCreateUser = async () => {
                    createUserError.value = '';
                    createUserSuccess.value = '';
                    
                    if (!createUserForm.value.email || !createUserForm.value.username || !createUserForm.value.password) {
                        createUserError.value = 'Email, username, and password are required';
                        return;
                    }
                    
                    if (createUserForm.value.password.length < 8) {
                        createUserError.value = 'Password must be at least 8 characters';
                        return;
                    }
                    
                    creatingUser.value = true;
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/users`, {
                            method: 'POST',
                            headers: {
                                ...getAuthHeaders(),
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(createUserForm.value)
                        });
                        
                        if (response.ok) {
                            createUserSuccess.value = 'User created successfully!';
                            createUserForm.value = { email: '', username: '', password: '', is_active: true, is_admin: false };
                            await fetchAdminUsers();
                            setTimeout(() => {
                                showCreateUserModal.value = false;
                                createUserSuccess.value = '';
                            }, 1500);
                        } else {
                            const err = await response.json();
                            createUserError.value = err.detail || 'Failed to create user';
                        }
                    } catch (e) {
                        createUserError.value = 'Failed to create user';
                    } finally {
                        creatingUser.value = false;
                    }
                };

                // Admin Registration Toggle
                const fetchRegistrationSetting = async () => {
                    if (!isAdmin.value) return;
                    
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/settings/registration`, {
                            headers: getAuthHeaders()
                        });
                        if (response.ok) {
                            const data = await response.json();
                            allowRegistration.value = data.allow_registration;
                        }
                    } catch (e) {
                        console.error('Failed to fetch registration setting:', e);
                    }
                };

                const toggleRegistration = async () => {
                    adminSettingsMessage.value = '';
                    
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/settings/registration`, {
                            method: 'PUT',
                            headers: {
                                ...getAuthHeaders(),
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ allow_registration: allowRegistration.value })
                        });
                        
                        if (response.ok) {
                            adminSettingsMessage.value = `Public registration ${allowRegistration.value ? 'enabled' : 'disabled'}`;
                            adminSettingsSuccess.value = true;
                            setTimeout(() => { adminSettingsMessage.value = ''; }, 3000);
                        } else {
                            const err = await response.json();
                            adminSettingsMessage.value = err.detail || 'Failed to update setting';
                            adminSettingsSuccess.value = false;
                            // Revert the checkbox
                            allowRegistration.value = !allowRegistration.value;
                        }
                    } catch (e) {
                        adminSettingsMessage.value = 'Failed to update setting';
                        adminSettingsSuccess.value = false;
                        allowRegistration.value = !allowRegistration.value;
                    }
                };

                // Subsidiary Management
                const fetchAvailableSubsidiaries = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/api/subsidiaries`);
                        if (response.ok) {
                            const data = await response.json();
                            availableSubsidiaries.value = data.active || [];
                            subsidiariesInfo.value = data;
                            
                            // If we have data for only one subsidiary, select it
                            if (data.with_data && data.with_data.length === 1) {
                                activeSubsidiary.value = data.with_data[0];
                            }
                        }
                    } catch (e) {
                        console.error('Failed to fetch subsidiaries:', e);
                    }
                };

                const updateSubsidiary = async () => {
                    adminSettingsMessage.value = '';
                    subsidiaryUpdating.value = true;
                    
                    try {
                        const response = await fetch(`${API_BASE}/api/config/subsidiary`, {
                            method: 'PUT',
                            headers: {
                                ...getAuthHeaders(),
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ code: selectedSubsidiary.value })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            subsidiary.value = data.subsidiary;
                            adminSettingsMessage.value = `Subsidiary updated to ${data.subsidiary.name}. Restart the checker to fetch new catalog data.`;
                            adminSettingsSuccess.value = true;
                            setTimeout(() => { adminSettingsMessage.value = ''; }, 5000);
                        } else {
                            const err = await response.json();
                            adminSettingsMessage.value = err.detail || 'Failed to update subsidiary';
                            adminSettingsSuccess.value = false;
                        }
                    } catch (e) {
                        adminSettingsMessage.value = 'Failed to update subsidiary';
                        adminSettingsSuccess.value = false;
                    } finally {
                        subsidiaryUpdating.value = false;
                    }
                };

                // Admin Group Management
                const fetchAdminGroups = async () => {
                    if (!isAdmin.value) return;
                    
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/groups`, {
                            headers: getAuthHeaders()
                        });
                        if (response.ok) {
                            adminGroups.value = await response.json();
                        }
                    } catch (e) {
                        console.error('Failed to fetch groups:', e);
                    }
                };

                const handleCreateGroup = async () => {
                    groupError.value = '';
                    
                    if (!createGroupForm.value.name) {
                        groupError.value = 'Group name is required';
                        return;
                    }
                    
                    savingGroup.value = true;
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/groups`, {
                            method: 'POST',
                            headers: {
                                ...getAuthHeaders(),
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(createGroupForm.value)
                        });
                        
                        if (response.ok) {
                            showToast('Group created');
                            createGroupForm.value = { name: '', description: '' };
                            showCreateGroupModal.value = false;
                            await fetchAdminGroups();
                        } else {
                            const err = await response.json();
                            groupError.value = err.detail || 'Failed to create group';
                        }
                    } catch (e) {
                        groupError.value = 'Failed to create group';
                    } finally {
                        savingGroup.value = false;
                    }
                };

                const editGroup = (group) => {
                    editGroupForm.value = { id: group.id, name: group.name, description: group.description || '' };
                    groupError.value = '';
                    showEditGroupModal.value = true;
                };

                const handleUpdateGroup = async () => {
                    groupError.value = '';
                    
                    if (!editGroupForm.value.name) {
                        groupError.value = 'Group name is required';
                        return;
                    }
                    
                    savingGroup.value = true;
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/groups/${editGroupForm.value.id}`, {
                            method: 'PUT',
                            headers: {
                                ...getAuthHeaders(),
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: editGroupForm.value.name,
                                description: editGroupForm.value.description
                            })
                        });
                        
                        if (response.ok) {
                            showToast('Group updated');
                            showEditGroupModal.value = false;
                            await fetchAdminGroups();
                        } else {
                            const err = await response.json();
                            groupError.value = err.detail || 'Failed to update group';
                        }
                    } catch (e) {
                        groupError.value = 'Failed to update group';
                    } finally {
                        savingGroup.value = false;
                    }
                };

                const confirmDeleteGroup = async (group) => {
                    if (!confirm(`Are you sure you want to delete the group "${group.name}"? This cannot be undone.`)) return;
                    
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/groups/${group.id}`, {
                            method: 'DELETE',
                            headers: getAuthHeaders()
                        });
                        if (response.ok) {
                            adminGroups.value = adminGroups.value.filter(g => g.id !== group.id);
                            showToast('Group deleted');
                        } else {
                            const err = await response.json();
                            showToast(err.detail || 'Failed to delete group');
                        }
                    } catch (e) {
                        showToast('Failed to delete group');
                    }
                };

                // Group Members Management
                const showGroupMembers = async (group) => {
                    selectedGroup.value = group;
                    groupMembersError.value = '';
                    addMemberUserId.value = '';
                    addMemberRole.value = 'member';
                    
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/groups/${group.id}/members`, {
                            headers: getAuthHeaders()
                        });
                        if (response.ok) {
                            groupMembers.value = await response.json();
                        } else {
                            groupMembers.value = [];
                        }
                    } catch (e) {
                        groupMembers.value = [];
                        console.error('Failed to fetch group members:', e);
                    }
                    
                    showGroupMembersModal.value = true;
                };

                const availableUsersForGroup = computed(() => {
                    const memberIds = new Set(groupMembers.value.map(m => m.user_id));
                    return adminUsers.value.filter(u => !memberIds.has(u.id));
                });

                const handleAddGroupMember = async () => {
                    if (!addMemberUserId.value || !selectedGroup.value) return;
                    
                    groupMembersError.value = '';
                    addingMember.value = true;
                    
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/groups/${selectedGroup.value.id}/members`, {
                            method: 'POST',
                            headers: {
                                ...getAuthHeaders(),
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                user_id: parseInt(addMemberUserId.value),
                                role: addMemberRole.value
                            })
                        });
                        
                        if (response.ok) {
                            showToast('Member added');
                            addMemberUserId.value = '';
                            addMemberRole.value = 'member';
                            // Refresh members list
                            await showGroupMembers(selectedGroup.value);
                            await fetchAdminGroups(); // Update member count
                        } else {
                            const err = await response.json();
                            groupMembersError.value = err.detail || 'Failed to add member';
                        }
                    } catch (e) {
                        groupMembersError.value = 'Failed to add member';
                    } finally {
                        addingMember.value = false;
                    }
                };

                const handleRemoveGroupMember = async (member) => {
                    if (!confirm(`Remove ${member.username} from this group?`)) return;
                    
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/groups/${selectedGroup.value.id}/members/${member.user_id}`, {
                            method: 'DELETE',
                            headers: getAuthHeaders()
                        });
                        
                        if (response.ok) {
                            groupMembers.value = groupMembers.value.filter(m => m.user_id !== member.user_id);
                            showToast('Member removed');
                            await fetchAdminGroups(); // Update member count
                        } else {
                            const err = await response.json();
                            showToast(err.detail || 'Failed to remove member');
                        }
                    } catch (e) {
                        showToast('Failed to remove member');
                    }
                };

                // All plans for subscription selection
                const allPlansForSubscription = computed(() => {
                    return plans.value.filter(p => p.enabled);
                });

                // Computed
                const availablePlans = computed(() => {
                    const planSet = new Set(status.value.map(s => s.plan_code));
                    return Array.from(planSet).sort();
                });

                const availableDatacenters = computed(() => {
                    const dcSet = new Set(status.value.map(s => s.datacenter));
                    return Array.from(dcSet).sort();
                });

                const totalPlans = computed(() => availablePlans.value.length);
                const totalDatacenters = computed(() => availableDatacenters.value.length);

                // Use location_region from API, fallback to guessing
                const getRegion = (item) => {
                    if (item.location_region) return item.location_region;
                    // Fallback for items without location data
                    const dc = item.datacenter.toUpperCase();
                    if (dc.includes('US-')) return 'US';
                    if (dc.includes('CA-') || dc.includes('BHS')) return 'CA';
                    if (dc.includes('EU-') || dc.includes('GRA') || dc.includes('SBG')) return 'EU';
                    if (dc.includes('AP-') || dc.includes('SYD') || dc.includes('SG')) return 'APAC';
                    return 'OTHER';
                };

                const filteredStatus = computed(() => {
                    return status.value.filter(item => {
                        // Filter by active subsidiary first
                        if (activeSubsidiary.value !== 'ALL' && item.subsidiary !== activeSubsidiary.value) {
                            return false;
                        }
                        if (filters.value.search) {
                            const search = filters.value.search.toLowerCase();
                            if (!item.plan_code.toLowerCase().includes(search) && 
                                !item.datacenter.toLowerCase().includes(search) &&
                                !(item.display_name || '').toLowerCase().includes(search) &&
                                !(item.location_city || '').toLowerCase().includes(search) &&
                                !(item.location_country || '').toLowerCase().includes(search)) {
                                return false;
                            }
                        }
                        if (filters.value.plan && item.plan_code !== filters.value.plan) return false;
                        if (filters.value.datacenter && item.datacenter !== filters.value.datacenter) return false;
                        if (filters.value.status === 'available' && !item.is_available) return false;
                        if (filters.value.status === 'unavailable' && item.is_available) return false;
                        if (filters.value.region && getRegion(item) !== filters.value.region) return false;
                        return true;
                    });
                });

                const filteredGroupedStatus = computed(() => {
                    const groups = {};
                    for (const item of filteredStatus.value) {
                        const basePlan = getBasePlanName(item.plan_code);
                        if (!groups[basePlan]) {
                            // Get base display name (strip regional suffixes from display name)
                            let baseDisplayName = (item.display_name || item.plan_code)
                                .replace(/\s*\((Canada|EU|Local Zone|EU Local Zone|US)\)\s*/gi, '')
                                .trim();
                            
                            groups[basePlan] = {
                                base_plan: basePlan,
                                display_name: baseDisplayName,
                                purchase_url: item.purchase_url,
                                price: item.price,
                                specs: item.specs,
                                vcpu: item.vcpu,
                                ram_gb: item.ram_gb,
                                storage_gb: item.storage_gb,
                                storage_type: item.storage_type,
                                bandwidth_mbps: item.bandwidth_mbps,
                                is_orderable: item.is_orderable !== false,
                                datacenters: [],
                                datacenterSet: new Set(),  // Track seen datacenters to avoid duplicates
                                available_count: 0,
                                unavailable_count: 0
                            };
                        }
                        
                        // Add datacenter only if not already seen (dedupe across regional variants)
                        if (!groups[basePlan].datacenterSet.has(item.datacenter)) {
                            groups[basePlan].datacenterSet.add(item.datacenter);
                            groups[basePlan].datacenters.push(item);
                            
                            if (item.is_available) {
                                groups[basePlan].available_count++;
                            } else {
                                groups[basePlan].unavailable_count++;
                            }
                        }
                        
                        // Update specs if we don't have them yet
                        if (!groups[basePlan].specs && item.specs) {
                            groups[basePlan].specs = item.specs;
                            groups[basePlan].vcpu = item.vcpu;
                            groups[basePlan].ram_gb = item.ram_gb;
                            groups[basePlan].storage_gb = item.storage_gb;
                            groups[basePlan].storage_type = item.storage_type;
                            groups[basePlan].bandwidth_mbps = item.bandwidth_mbps;
                        }
                    }
                    return groups;
                });

                // Split into orderable and internal plans
                const orderablePlans = computed(() => {
                    const result = {};
                    for (const [key, group] of Object.entries(filteredGroupedStatus.value)) {
                        if (group.is_orderable) {
                            result[key] = group;
                        }
                    }
                    return result;
                });

                const internalPlans = computed(() => {
                    const result = {};
                    for (const [key, group] of Object.entries(filteredGroupedStatus.value)) {
                        if (!group.is_orderable) {
                            result[key] = group;
                        }
                    }
                    return result;
                });

                const stats = computed(() => {
                    const filtered = filteredStatus.value;
                    return {
                        available: filtered.filter(s => s.is_available).length,
                        outOfStock: filtered.filter(s => !s.is_available).length,
                        plans: Object.keys(filteredGroupedStatus.value).length,
                        orderablePlans: Object.keys(orderablePlans.value).length,
                        internalPlans: Object.keys(internalPlans.value).length,
                        datacenters: new Set(filtered.map(s => s.datacenter)).size
                    };
                });

                const hasActiveFilters = computed(() => {
                    return filters.value.search || filters.value.plan || filters.value.datacenter || 
                           filters.value.status || filters.value.region;
                });

                const allOrderableCollapsed = computed(() => {
                    const keys = Object.keys(orderablePlans.value);
                    if (keys.length === 0) return false;
                    return keys.every(k => collapsedPlans.value[k]);
                });

                const allInternalCollapsed = computed(() => {
                    const keys = Object.keys(internalPlans.value);
                    if (keys.length === 0) return false;
                    return keys.every(k => collapsedPlans.value[k]);
                });

                // Datacenter view - plans for a specific datacenter
                const datacenterPlans = computed(() => {
                    if (!selectedDatacenter.value) return [];
                    return status.value
                        .filter(item => item.datacenter === selectedDatacenter.value)
                        .map(item => ({
                            ...item,
                            base_plan: getBasePlanName(item.plan_code),
                            display_name_clean: (item.display_name || item.plan_code)
                                .replace(/\s*\((Canada|EU|Local Zone|EU Local Zone|US)\)\s*/gi, '').trim()
                        }))
                        .sort((a, b) => {
                            // Sort by display name or plan code
                            const aName = a.display_name_clean || a.plan_code;
                            const bName = b.display_name_clean || b.plan_code;
                            return aName.localeCompare(bName, undefined, { numeric: true });
                        });
                });

                const datacenterInfo = computed(() => {
                    if (!selectedDatacenter.value || datacenterPlans.value.length === 0) return null;
                    const sample = datacenterPlans.value[0];
                    return {
                        datacenter: selectedDatacenter.value,
                        location_city: sample.location_city,
                        location_country: sample.location_country,
                        location_flag: sample.location_flag,
                        total: datacenterPlans.value.length,
                        available: datacenterPlans.value.filter(p => p.is_available).length,
                        unavailable: datacenterPlans.value.filter(p => !p.is_available).length
                    };
                });

                // URL handling
                const parseHash = () => {
                    const hash = window.location.hash.slice(1) || '/status';
                    const [path, queryString] = hash.split('?');
                    const tab = path.replace('/', '') || 'status';
                    
                    activeTab.value = ['status', 'datacenter', 'history', 'notifications', 'settings', 'my-alerts', 'admin'].includes(tab) ? tab : 'status';
                    
                    if (queryString) {
                        const params = new URLSearchParams(queryString);
                        filters.value.search = params.get('search') || '';
                        filters.value.plan = params.get('plan') || '';
                        filters.value.datacenter = params.get('datacenter') || '';
                        filters.value.status = params.get('status') || '';
                        filters.value.region = params.get('region') || '';
                        // Handle datacenter tab selection
                        if (tab === 'datacenter' && params.get('dc')) {
                            selectedDatacenter.value = params.get('dc');
                        }
                    }
                };

                const updateUrl = () => {
                    const params = new URLSearchParams();
                    if (filters.value.search) params.set('search', filters.value.search);
                    if (filters.value.plan) params.set('plan', filters.value.plan);
                    if (filters.value.datacenter) params.set('datacenter', filters.value.datacenter);
                    if (filters.value.status) params.set('status', filters.value.status);
                    if (filters.value.region) params.set('region', filters.value.region);
                    
                    const query = params.toString();
                    const newHash = `#/${activeTab.value}${query ? '?' + query : ''}`;
                    
                    if (window.location.hash !== newHash) {
                        window.history.replaceState(null, '', newHash);
                    }
                };

                const copyPermalink = async () => {
                    updateUrl();
                    try {
                        await navigator.clipboard.writeText(window.location.href);
                        showToast('Link copied!');
                    } catch (err) {
                        showToast('Failed to copy link');
                    }
                };

                const showToast = (message) => {
                    toast.value = { visible: true, message };
                    setTimeout(() => toast.value.visible = false, 2500);
                };

                const clearFilters = () => {
                    filters.value = { search: '', plan: '', datacenter: '', status: '', region: '' };
                    updateUrl();
                };

                const filterByDatacenter = (dc) => {
                    filters.value.datacenter = filters.value.datacenter === dc ? '' : dc;
                    updateUrl();
                };

                const togglePlanCollapse = (planCode) => {
                    collapsedPlans.value[planCode] = !collapsedPlans.value[planCode];
                };

                const toggleGroupCollapse = (basePlan) => {
                    collapsedGroups.value[basePlan] = !collapsedGroups.value[basePlan];
                };

                const toggleCollapseAll = (section) => {
                    const plans = section === 'orderable' ? orderablePlans.value : internalPlans.value;
                    const keys = Object.keys(plans);
                    const allCollapsed = section === 'orderable' ? allOrderableCollapsed.value : allInternalCollapsed.value;
                    keys.forEach(k => {
                        collapsedPlans.value[k] = !allCollapsed;
                    });
                };

                const selectDatacenter = (dc) => {
                    selectedDatacenter.value = dc;
                    activeTab.value = 'datacenter';
                    window.location.hash = `#/datacenter?dc=${encodeURIComponent(dc)}`;
                };

                const formatBasePlanName = (basePlan) => {
                    // Convert vps-2025-model1 to "VPS Model 1" etc.
                    const match = basePlan.match(/vps-(\d+)-model(\d+)(\.LZ)?/i);
                    if (match) {
                        const year = match[1];
                        const model = match[2];
                        const lz = match[3] ? ' (Local Zone)' : '';
                        const names = {
                            '1': 'Starter',
                            '2': 'Value',
                            '3': 'Essential',
                            '4': 'Comfort',
                            '5': 'Elite',
                            '6': 'Premium'
                        };
                        return `VPS ${names[model] || 'Model ' + model}${lz}`;
                    }
                    return basePlan;
                };

                const showAlert = (message, type = 'success') => {
                    alertMessage.value = message;
                    alertType.value = type;
                    setTimeout(() => alertMessage.value = '', 5000);
                };

                const formatDate = (dateStr) => {
                    if (!dateStr) return '‚Äî';
                    return new Date(dateStr).toLocaleString();
                };

                const formatDuration = (minutes) => {
                    if (minutes < 60) return `${Math.round(minutes)}m`;
                    if (minutes < 1440) return `${Math.round(minutes / 60)}h`;
                    return `${Math.round(minutes / 1440)}d`;
                };

                // API calls - only update data, don't refresh entire page
                const fetchStatus = async (showIndicator = false) => {
                    try {
                        if (showIndicator) isRefreshing.value = true;
                        const response = await fetch(`${API_BASE}/api/status`);
                        status.value = await response.json();
                    } catch (error) {
                        console.error('Failed to fetch status:', error);
                    } finally {
                        loading.value = false;
                        isRefreshing.value = false;
                    }
                };

                const fetchHistory = async () => {
                    if (!isAuthenticated.value) return;
                    try {
                        historyLoading.value = true;
                        let url = `${API_BASE}/api/status/history?limit=${historyFilters.value.limit}`;
                        if (historyFilters.value.plan) url += `&plan_code=${encodeURIComponent(historyFilters.value.plan)}`;
                        const response = await fetch(url, {
                            headers: getAuthHeaders()
                        });
                        if (response.ok) {
                            history.value = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to fetch history:', error);
                    } finally {
                        historyLoading.value = false;
                    }
                };

                const fetchNotifications = async () => {
                    if (!isAuthenticated.value) return;
                    try {
                        notificationsLoading.value = true;
                        const response = await fetch(`${API_BASE}/api/notifications`, {
                            headers: getAuthHeaders()
                        });
                        if (response.ok) {
                            notifications.value = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to fetch notifications:', error);
                    } finally {
                        notificationsLoading.value = false;
                    }
                };

                const fetchPlans = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/api/plans`);
                        plans.value = await response.json();
                    } catch (error) {
                        console.error('Failed to fetch plans:', error);
                    }
                };

                const fetchSubsidiary = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/api/subsidiary`);
                        if (response.ok) {
                            subsidiary.value = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to fetch subsidiary info:', error);
                    }
                };

                const fetchConfig = async () => {
                    if (!isAdmin.value) return;
                    try {
                        const response = await fetch(`${API_BASE}/api/config`, {
                            headers: getAuthHeaders()
                        });
                        if (response.ok) {
                            config.value = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to fetch config:', error);
                    }
                };

                const saveWebhook = async () => {
                    if (!webhookUrl.value) {
                        showAlert('Please enter a webhook URL', 'danger');
                        return;
                    }
                    try {
                        saving.value = true;
                        const response = await fetch(`${API_BASE}/api/config/discord-webhook`, {
                            method: 'PUT',
                            headers: { 
                                'Content-Type': 'application/json',
                                ...getAuthHeaders()
                            },
                            body: JSON.stringify({ webhook_url: webhookUrl.value })
                        });
                        if (response.ok) {
                            showAlert('Webhook saved!', 'success');
                            webhookUrl.value = '';
                            await fetchConfig();
                        } else {
                            const error = await response.json();
                            showAlert(error.detail || 'Failed to save', 'danger');
                        }
                    } catch (error) {
                        showAlert('Error: ' + error.message, 'danger');
                    } finally {
                        saving.value = false;
                    }
                };

                const testWebhook = async () => {
                    try {
                        testing.value = true;
                        const response = await fetch(`${API_BASE}/api/config/discord-webhook/test`, { 
                            method: 'POST',
                            headers: getAuthHeaders()
                        });
                        const result = await response.json();
                        showAlert(result.success ? 'Test sent!' : 'Test failed: ' + result.message, 
                                  result.success ? 'success' : 'danger');
                        await fetchNotifications();
                    } catch (error) {
                        showAlert('Error: ' + error.message, 'danger');
                    } finally {
                        testing.value = false;
                    }
                };

                const togglePlanEnabled = async (plan) => {
                    try {
                        const response = await fetch(`${API_BASE}/api/plans/${encodeURIComponent(plan.plan_code)}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ enabled: !plan.enabled })
                        });
                        if (response.ok) {
                            plan.enabled = !plan.enabled;
                            showToast(`Plan ${plan.enabled ? 'enabled' : 'disabled'}`);
                        }
                    } catch (error) {
                        showAlert('Error: ' + error.message, 'danger');
                    }
                };

                const showPricing = async (planCode) => {
                    pricingModal.value = { visible: true, loading: true, planCode, tiers: [], lastUpdated: '' };
                    
                    try {
                        const [tiersRes, infoRes] = await Promise.all([
                            fetch(`${API_BASE}/api/pricing/${encodeURIComponent(planCode)}`),
                            fetch(`${API_BASE}/api/pricing`)
                        ]);
                        pricingModal.value.tiers = await tiersRes.json();
                        const info = await infoRes.json();
                        pricingModal.value.lastUpdated = info.last_updated ? new Date(info.last_updated).toLocaleString() : 'Unknown';
                    } catch (error) {
                        console.error('Failed to fetch pricing:', error);
                    } finally {
                        pricingModal.value.loading = false;
                    }
                };

                // Watch tab changes
                watch(activeTab, (newTab) => {
                    updateUrl();
                    if (newTab === 'history' && history.value.length === 0) fetchHistory();
                    if (newTab === 'notifications' && notifications.value.length === 0) fetchNotifications();
                    if (newTab === 'settings' && plans.value.length === 0) {
                        fetchPlans();
                        fetchConfig();
                    }
                    if (newTab === 'my-alerts' && isAuthenticated.value) {
                        fetchUserData();
                        if (plans.value.length === 0) fetchPlans();
                    }
                    if (newTab === 'admin' && isAdmin.value) {
                        fetchAdminUsers();
                        fetchAdminGroups();
                        fetchRegistrationSetting();
                        fetchAvailableSubsidiaries();
                        // Set selected subsidiary from current config
                        selectedSubsidiary.value = subsidiary.value.code;
                    }
                });

                // Initialize
                onMounted(async () => {
                    // Check authentication first
                    await checkAuth();
                    
                    // Fetch subsidiary info (multi-subsidiary data)
                    await fetchAvailableSubsidiaries();
                    fetchSubsidiary();
                    
                    parseHash();
                    
                    // Initial data load
                    fetchStatus();
                    
                    // Load user data if authenticated
                    if (isAuthenticated.value) {
                        fetchUserData();
                    }
                    
                    // Background refresh every 30 seconds - only updates data, not page
                    refreshInterval = setInterval(() => {
                        fetchStatus(true);
                    }, 30000);
                    
                    window.addEventListener('hashchange', parseHash);
                });

                onUnmounted(() => {
                    if (refreshInterval) clearInterval(refreshInterval);
                    window.removeEventListener('hashchange', parseHash);
                });

                return {
                    activeTab, loading, historyLoading, notificationsLoading, isRefreshing,
                    saving, testing, status, history, notifications, plans, config, webhookUrl,
                    alertMessage, alertType, collapsedPlans, collapsedGroups, showInternalPlans, filters, historyFilters, 
                    pricingModal, toast, availablePlans, availableDatacenters, totalPlans, 
                    totalDatacenters, filteredGroupedStatus, orderablePlans, internalPlans, stats, hasActiveFilters,
                    allOrderableCollapsed, allInternalCollapsed, selectedDatacenter, datacenterPlans, datacenterInfo,
                    subsidiary,
                    // Multi-subsidiary support
                    subsidiariesInfo, activeSubsidiary, subsidiariesWithData,
                    getSubsidiaryFlag, getSubsidiaryName, getSubsidiaryCount, setActiveSubsidiary,
                    formatDate, formatDuration, formatBasePlanName, saveWebhook, testWebhook, togglePlanEnabled,
                    showPricing, updateUrl, copyPermalink, clearFilters, filterByDatacenter, 
                    togglePlanCollapse, toggleGroupCollapse, toggleCollapseAll, selectDatacenter, fetchHistory, showAlert,
                    // Auth
                    isAuthenticated, isAdmin, currentUser, authLoading, authError,
                    showLoginModal, showRegisterModal, loginForm, registerForm,
                    handleLogin, handleRegister, logout,
                    // User data
                    userWebhooks, userSubscriptions, userNotifications, selectedPlans, savingSubscriptions,
                    showAddWebhookModal, webhookError, addingWebhook, newWebhookForm, webhookColorPicker,
                    handleAddWebhook, testUserWebhook, toggleUserWebhook, deleteUserWebhook,
                    togglePlanSubscription, selectAllPlans, deselectAllPlans, saveSubscriptions,
                    allPlansForSubscription,
                    // Admin data
                    adminUsers, adminGroups, adminLoading, fetchAdminUsers, fetchAdminGroups,
                    toggleUserActive, toggleUserAdmin, confirmDeleteUser,
                    // Admin user creation
                    showCreateUserModal, createUserForm, createUserError, createUserSuccess, creatingUser,
                    handleCreateUser,
                    // Admin settings
                    allowRegistration, adminSettingsMessage, adminSettingsSuccess,
                    fetchRegistrationSetting, toggleRegistration,
                    availableSubsidiaries, selectedSubsidiary, subsidiaryUpdating,
                    fetchAvailableSubsidiaries, updateSubsidiary,
                    // Admin group management
                    showCreateGroupModal, showEditGroupModal, showGroupMembersModal,
                    createGroupForm, editGroupForm, groupError, savingGroup,
                    handleCreateGroup, editGroup, handleUpdateGroup, confirmDeleteGroup,
                    // Group members
                    selectedGroup, groupMembers, groupMembersError, addMemberUserId, addMemberRole, addingMember,
                    availableUsersForGroup, showGroupMembers, handleAddGroupMember, handleRemoveGroupMember
                };
            }
        }).mount('#app');
    </script>
</body>
</html>